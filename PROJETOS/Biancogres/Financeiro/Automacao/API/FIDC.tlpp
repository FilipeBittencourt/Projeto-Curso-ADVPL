#include "totvs.ch"
#include "parmtype.ch"
#include "dbstruct.ch"

/*/{Protheus.doc} FIDC
@author Marinaldo de Jesus
@since 01/02/2021
@project FIDC
@version 1.0
@description Classe para Tratamento FIDC
@type class
/*/

static abcoIsFIDC   as array
static aRGRIsFIDC   as array

static oFIDCVars    as object
static oFIDCPars    as object

class FIDC

    static method isFIDCEnabled() as logical

    static method bcoIsFIDC() as logical
    static method getbcoFIDC(lClear as logical) as array

    static method retbcoFIDC() as array

    static method regrabcoIsFIDC(nType as numeric) as logical
    static method getregrabcoIsFIDC(lClear as logical) as array

    static method ctbFIDC(nType as numeric) as numeric
    static method isctbFIDC(nType as numeric) as logical
    static method isLPctbFIDC(cPadrao as character,nType as numeric) as logical

    static method ctbFIDCOffLine(nType as numeric) as logical
    static method txFIDCOffLine() as logical

    static method setFIDCVar(uVar,uVal)
    static method getFIDCVar(uVar,uDefault)
    static method resetFIDCVars()

    static method percentualDesconto() as numeric
    static method calculaDesconto(nValor as numeric,dVencimento as date,dReferencia as date) as numeric

    static method getBiaPar(cParam as character,xDefault,cEmp as character,cFil as character)
    static method putBiaPar(cParam as character,cConteudo as character,cEmp as character,cFil as character)
    static method existBiaPar(cParam as character,cEmp as character,cFil as character) as logical
    static method InsertBiaPar(cParam as character,cConteudo as character,cEmp as character,cFil as character) as logical
    static method resetFIDCPars()

    static method getRecParamRem(aParamRet as array) as logical
    static method getRecQueryRem(aParamRet as array,abcoIsFIDC as array,aFWTTables as array) as character

    static method getRecParamRet(aParamRet as array) as logical
    static method getRecQueryRet(aParamRet as array,abcoIsFIDC as array,aFWTTables as array) as character
 
    static method getRecParamRec(aParamRet as array) as logical
    static method getRecQueryRec(aParamRet as array,abcoIsFIDC as array,aFWTTables as array) as character
    
    static method getRecParamCon(aParamRet as array) as logical
    static method getRecQueryCon(aParamRet as array,abcoIsFIDC as array,aFWTTables as array) as character

    static method getPagParamRem(aParamRet as array) as logical
    static method getPagQueryRem(aParamRet as array,aFWTTables as array) as character

    static method getPagParamRet(aParamRet as array) as logical
    static method getPagQueryRet(aParamRet as array,aFWTTables as array) as character

    static method getPagParamTit(aParamRet as array) as logical
    static method getPagQueryTit(aParamRet as array,aFWTTables as array) as character

    static method getPagParamLiq(aParamRet as array) as logical
    static method getPagQueryLiq(aParamRet as array,aFWTTables as array) as character

    static method getPagParamCon(aParamRet as array) as logical
    static method getPagQueryCon(aParamRet as array,aFWTTables as array) as character

    static method getQueryMovBco(dDataRef) as character
    static method movBcoFIDC(dDataRef as date) as logical

    static method getVlrCTBPagar() as numeric
    static method getHisCTBPagar(cTypeHist) as character
    static method getCTACTBPagar(cTypeCTA) as character

    static method isPGFIDC(lHelp as logical,cMsg as character)  as logical
    static method isRecFIDC(lHelp as logical,cMsg as character)  as logical
  
    static method getLPFIDC(nType) as character

    static method getPGFilterFIDC(lAdvPL) as character

    static method FIDCYLEGEND(nType) as character

end class

static method isFIDCEnabled() class FIDC

    static s__cKeyFIDC      as character
    static s__lA6YTPINTB    as logical

    local lChkFiDC           as logical
    DEFAULT s__cKeyFIDC:="__cKeyFIDC__"

    lChkFiDC:=(type("cEmpAnt")=="C").and.(!&("cEmpAnt")==s__cKeyFIDC)
    if (lChkFiDC)
        s__cKeyFIDC:=&("cEmpAnt")
        s__lA6YTPINTB:=SA6->(FieldPos("A6_YTPINTB")>0)
    endif

    DEFAULT s__lA6YTPINTB:=.F.

    return(s__lA6YTPINTB)

static method bcoIsFIDC() class FIDC

    local aArea         as array

    local bbcoIsFIDC    as codeblock

    local cEmp          as character
    local cFil          as character

    local cBanco        as character
    local cAgencia      as character
    local cConta        as character
    local cTmpAlias     as character

    local lbcoIsFIDC    as logical

    local nSA6RecNo     as numeric
    local nbcoIsFIDC    as numeric

    lbcoIsFIDC:=.F.

    cBanco:=FIDC():getFIDCVar("cBanco","")
    cAgencia:=FIDC():getFIDCVar("cAgencia","")
    cConta:=FIDC():getFIDCVar("cConta","")

    cEmp:=&("cEmpAnt")
    cFil:=&("cFilAnt")

    DEFAULT abcoIsFIDC:=array(0)
    bbcoIsFIDC:={|e|(e[1]==cEmp).and.(e[2]==cFil).and.(e[3]==cBanco).and.(e[4]==cAgencia).and.(e[5]==cConta)}
    nbcoIsFIDC:=aScan(abcoIsFIDC,bbcoIsFIDC)
    if (nbcoIsFIDC==0)

        aArea:=FWGetArea()

        cTmpAlias:=getNextAlias()

        beginSQL alias cTmpAlias
            
            %noparser%
            
            SELECT SA6.R_E_C_N_O_ SA6RECNO
                FROM %table:SA6% SA6
            WHERE SA6.%notDel%
                AND SA6.A6_FILIAL=%xFilial:SA6%
                AND SA6.A6_COD=%exp:cBanco%
                AND SA6.A6_AGENCIA=%exp:cAgencia%
                AND SA6.A6_NUMCON=%exp:cConta%
                AND SA6.A6_YTPINTB='1'
        
        endSQL

        nSA6RecNo:=0

        while (cTmpAlias)->(!eof())
            nSA6RecNo:=(cTmpAlias)->SA6RECNO
            if (nSA6RecNo>0)
                lbcoIsFIDC:=.T.
                SA6->(MsGoTo(nSA6RecNo))
                exit
            endif
            (cTmpAlias)->(dbSkip())
        end while

        (cTmpAlias)->(dbCloseArea())
        dbSelectArea("SA6")

        FWRestArea(aArea)

        aAdd(abcoIsFIDC,{cEmp,cFil,cBanco,cAgencia,cConta,nSA6RecNo,lbcoIsFIDC})
        nbcoIsFIDC:=len(abcoIsFIDC)

    endif

    nSA6RecNo:=abcoIsFIDC[nbcoIsFIDC][6]
    SA6->(MsGoTo(nSA6RecNo))

    lbcoIsFIDC:=abcoIsFIDC[nbcoIsFIDC][7]
    if (lbcoIsFIDC)
        FIDC():setFIDCVar("nSA6RecNo",nSA6RecNo)
    endif

    return(lbcoIsFIDC)

static method getbcoFIDC(lClear) class FIDC
    paramtype lClear as logical optional default .F.
    DEFAULT abcoIsFIDC:=array(0)
    if (lClear)
        aSize(abcoIsFIDC,0)
    endif
    return(abcoIsFIDC)

static method retbcoFIDC() class FIDC

    local cEmp      as character
    local cFil      as character
    local cBanco    as character
    local cAgencia  as character
    local cConta    as character
    local cTmpAlias as character

    local nSA6RecNo as numeric

    cTmpAlias:=getNextAlias()

    beginSQL alias cTmpAlias
        
        %noparser%
        
        SELECT SA6.R_E_C_N_O_ SA6RECNO
          FROM %table:SA6% SA6
         WHERE SA6.%notDel%
           AND SA6.A6_FILIAL=%xFilial:SA6%
           AND SA6.A6_YTPINTB='1'
    
    endSQL

    DEFAULT abcoIsFIDC:=array(0)

    cEmp:=&("cEmpAnt")
    cFil:=&("cFilAnt")

    DEFAULT abcoIsFIDC:=array(0)
    bbcoIsFIDC:={|e|(e[1]==cEmp).and.(e[2]==cFil).and.(e[3]==cBanco).and.(e[4]==cAgencia).and.(e[5]==cConta)}

    while (cTmpAlias)->(!eof())
        nSA6RecNo:=(cTmpAlias)->SA6RECNO
        SA6->(dbGoTo(nSA6RecNo))
        cBanco:=SA6->A6_COD
        cAgencia:=SA6->A6_AGENCIA
        cConta:=SA6->A6_NUMCON
        nbcoIsFIDC:=aScan(abcoIsFIDC,bbcoIsFIDC)
        if (nbcoIsFIDC==0)
            aAdd(abcoIsFIDC,{cEmp,cFil,cBanco,cAgencia,cConta,nSA6RecNo,(SA6->A6_YTPINTB=="1")})
        endif
        (cTmpAlias)->(dbSkip())
    end while

    return(abcoIsFIDC)

static method regrabcoIsFIDC(nType) class FIDC

    local aArea         as array

    local bbcoIsFIDC    as codeblock
    local bRGRIsFIDC    as codeblock

    local cEmp          as character
    local cFil          as character

    local cType         as character

    local cBanco        as character
    local cAgencia      as character
    local cConta        as character

    local cTmpAlias     as character
    local cYCDGREG      as character

    local lRGRIsFIDC    as logical

    local nSA6RecNo     as numeric

    local nRGRIsFIDC    as numeric
    local nbcoIsFIDC    as numeric

    paramtype nType as numeric optional default 1

    cType:=cValToChar(nType)

    if (nType==1)
        cYCDGREG:=FIDC():getFIDCVar("A1_YCDGREG","")
    elseif (nType==2)
        cYCDGREG:=FIDC():getFIDCVar("A2_YCDGREG","")
        if (empty(cYCDGREG))
            cYCDGREG:=FIDC():getFIDCVar("E2_YCDGREG","")
        else
            cType:="1"
        endif
    else
        cYCDGREG:=""
    endif

    cEmp:=&("cEmpAnt")
    cFil:=&("cFilAnt")

    DEFAULT aRGRIsFIDC:=array(0)
    bRGRIsFIDC:={|e|(e[1]==cEmp).and.(e[2]==cFil).and.(e[3]==cYCDGREG)}
    nRGRIsFIDC:=aScan(aRGRIsFIDC,bRGRIsFIDC)
    if (nRGRIsFIDC==0)

        aArea:=FWGetArea()

        cTmpAlias:=getNextAlias()

        beginSQL alias cTmpAlias
            
            %noparser%
            
            SELECT SA6.R_E_C_N_O_ SA6RECNO
              FROM %table:ZK0% ZK0
              JOIN %table:ZK1% ZK1
                ON ZK0.ZK0_FILIAL=ZK1.ZK1_FILIAL
               AND ZK0.ZK0_CODREG=ZK1.ZK1_CODREG
               AND ZK1.%notDel%
              JOIN %table:SA6% SA6
                ON SA6.A6_FILIAL=%xFilial:SA6%
               AND SA6.A6_COD=ZK1.ZK1_BANCO
               AND SA6.A6_AGENCIA=ZK1.ZK1_AGENCI
               AND SA6.A6_NUMCON=ZK1.ZK1_CONTA
               AND SA6.%notDel%
             WHERE ((CASE %exp:cType% WHEN '1' THEN (CASE WHEN (ZK0.ZK0_CODGRU=%exp:cYCDGREG%) THEN 1 ELSE 0 END) ELSE (CASE WHEN (ZK0.ZK0_CODREG=%exp:cYCDGREG%) THEN 1 ELSE 0 END) END)=1)
               AND ZK0.ZK0_FILIAL=%xFilial:ZK0%
               AND ZK0.%notDel%
        endSQL

        nSA6RecNo:=(cTmpAlias)->SA6RECNO
        SA6->(MsGoTo(nSA6RecNo))

        cBanco:=SA6->A6_COD
        cAgencia:=SA6->A6_AGENCIA
        cConta:=SA6->A6_NUMCON

        lRGRIsFIDC:=(SA6->A6_YTPINTB=='1')

        (cTmpAlias)->(dbCloseArea())
        dbSelectArea("SA6")

        FWRestArea(aArea)

        aAdd(aRGRIsFIDC,{cEmp,cFil,cYCDGREG,lRGRIsFIDC,cBanco,cAgencia,cConta,nSA6RecNo})

        bbcoIsFIDC:={|e|(e[1]==cEmp).and.(e[2]==cFil).and.(e[3]==cBanco).and.(e[4]==cAgencia).and.(e[5]==cConta)}
        nbcoIsFIDC:=aScan(abcoIsFIDC,bbcoIsFIDC)
        if (nbcoIsFIDC==0)
            DEFAULT abcoIsFIDC:=array(0)
            FIDC():setFIDCVar("nSA6RecNo",nSA6RecNo)
            aAdd(abcoIsFIDC,{cEmp,cFil,cBanco,cAgencia,cConta,nSA6RecNo,lRGRIsFIDC})
        endif

        nRGRIsFIDC:=len(aRGRIsFIDC)

    endif

    lRGRIsFIDC:=aRGRIsFIDC[nRGRIsFIDC][4]
    nSA6RecNo:=aRGRIsFIDC[nRGRIsFIDC][8]
    SA6->(MsGoTo(nSA6RecNo))

    return(lRGRIsFIDC)

static method getregrabcoIsFIDC(lClear) class FIDC
    paramtype lClear as logical optional default .F.
    DEFAULT aRGRIsFIDC:=array(0)
    if (lClear)
        aSize(aRGRIsFIDC,0)
    endif
    return(aRGRIsFIDC)

static method ctbFIDC(nType) class FIDC

    local aArea     as array
    local aAreaSA1  as array
    local aAreaSA2  as array
    local aAreaSA6  as array
    local aAreaSE1  as array
    local aAreaSE2  as array
    local aAreaSE5  as array

    local aDiario   as array
    local aFlagCTB  as array

    local cLote     as character
    local cPadrao   as character
    local cFunCTB   as character
    local cArquivo  as character

    local lPadrao   as logical
    local lDigita   as logical
    local lDiario   as logical
    local lUsaFlag  as logical
    local lA100Incl as logical

    local nTotal    as numeric
    local nHdlPrv   as numeric

    local nSA1RecNo as numeric
    local nSA2RecNo as numeric
    local nSA6RecNo as numeric
    local nSE1RecNo as numeric

    paramtype nType as numeric optional default 1

    aArea:=FWGetArea()

    aAreaSA1:=SA1->(getArea())
    aAreaSA2:=SA2->(getArea())
    aAreaSA6:=SA6->(getArea())
    aAreaSE1:=SE1->(getArea())
    aAreaSE2:=SE2->(getArea())
    aAreaSE5:=SE5->(getArea())

    begin sequence

        if (!FIDC():bcoIsFIDC())
            break
        endif

        if (nType==1)
            nSA1RecNo:=FIDC():getFIDCVar("nSA1RecNo",0)
            if (!empty(nSA1RecNo))
                SA1->(MsGoTo(nSA1RecNo))
            endif
        elseif (nType==2)
            nSA2RecNo:=FIDC():getFIDCVar("nSA2RecNo",0)
            if (!empty(nSA2RecNo))
                SA2->(MsGoTo(nSA2RecNo))
            endif
        else
            nSA1RecNo:=0
            SA1->(MsGoTo(nSA1RecNo))
            nSA2RecNo:=0
            SA2->(MsGoTo(nSA2RecNo))
        endif

        nSA6RecNo:=FIDC():getFIDCVar("nSA6RecNo",0)
        if (!empty(nSA6RecNo))
            SA6->(MsGoTo(nSA6RecNo))
        endif

        if (nType==1)
            nSE1RecNo:=FIDC():getFIDCVar("nSE1RecNo",0)
            if (!empty(nSE1RecNo))
                SE1->(MsGoTo(nSE1RecNo))
            endif
        elseif (nType==2)
            nSE2RecNo:=FIDC():getFIDCVar("nSE2RecNo",0)
            if (!empty(nSE2RecNo))
                SE2->(MsGoTo(nSE2RecNo))
            endif
        else
            nSE1RecNo:=0
            SE1->(MsGoTo(nSE1RecNo))
            nSE2RecNo:=0
            SE2->(MsGoTo(nSE2RecNo))
        endif

        cPadrao:=FIDC():getFIDCVar("cPadrao","")

        lPadrao:=VerPadrao(cPadrao)

        if (!lPadrao)
            break
        endif

        cFunCTB:=FIDC():getBiaPar("FIDC_FUNCTB","CTBFIDC")
        cLote:=FIDC():getBiaPar("FIDC_LOTECTB","008850")

        cArquivo:=""
        nHdlPrv:=HeadProva(cLote,cFunCTB,SubStr(&("cUsuario"),7,6),@cArquivo)

        if (empty(nHdlPrv))
            break
        endif

        if (!(nHdlPrv>0))
            break
        endif

        lUsaFlag:=FIDC():getFIDCVar("lUsaFlag",.F.)
        if (lUsaFlag)
            // Armazena em aFlagCTB para atualizar no modulo Contabil
            aFlagCTB:=array(0)
            aAdd(aFlagCTB,FIDC():getFIDCVar("aFlagCTB",{"","","",0,0,0,0}))
        endif

        lDiario:=FIDC():getFIDCVar("lDiario",.F.)
        if (lDiario)
            aDiario:=array(0)
            aAdd(aDiario,FIDC():getFIDCVar("aDiario",{"",0,0,"",""}))
        EndIf

        nTotal:=DetProva(nHdlPrv,cPadrao,cFunCTB,cLote,/*nLinha*/,/*lExecuta*/,;
                            /*cCriterio*/, /*lRateio*/, /*cChaveBusca*/, /*aCT5*/,;
                            /*lPosiciona*/,@aFlagCTB,/*aTabRecOri*/,/*aDadosProva*/)

        if (nTotal>0)
            RodaProva(nHdlPrv,nTotal)
            lDigita:=.F.
            lA100Incl:=cA100Incl(cArquivo,nHdlPrv,3/*nOpcx*/,cLote,lDigita,.F./*lAglut*/,/*cOnLine*/,/*dData*/,/*dReproc*/, @aFlagCTB,/*aDadosProva*/,@aDiario)
            DEFAULT lA100Incl:=.F.
            if (!lA100Incl)
                nTotal:=0
            endif
        endif

    end sequence

    restArea(aAreaSA1)
    restArea(aAreaSA2)
    restArea(aAreaSA6)
    restArea(aAreaSE1)
    restArea(aAreaSE2)
    restArea(aAreaSE5)

    FWRestArea(aArea)

    DEFAULT nTotal:=0

    return(nTotal)

static method isctbFIDC(nType) class FIDC

    local aArea         as array
    local aAreaSA1      as array
    local aAreaSA2      as array
    local aAreaSA6      as array 
    local aAreaSE1      as array
    local aAreaSE2      as array
    local aAreaSE5      as array 

    local aStack        as array

    local cSA1IdxKey    as character
    local cSA2IdxKey    as character

    local lCTBFIDC      as logical
    local lbcoIsFIDC    as logical

    local nSA1RecNo     as numeric
    local nSE1RecNo     as numeric

    local nSA2RecNo     as numeric
    local nSE2RecNo     as numeric

    paramtype nType as numeric optional default 1

    aArea:=FWGetArea()
    
    aAreaSA1:=SA1->(getArea())
    aAreaSA2:=SA2->(getArea())
    aAreaSA6:=SA6->(getArea())
    aAreaSE1:=SE1->(getArea())
    aAreaSE2:=SE2->(getArea())
    aAreaSE5:=SE5->(getArea())

    lCTBFIDC:=.F.

    begin sequence

        if (nType==1)

            if (stackTools():IsInCallStack("FINA100"))

                FIDC():setFIDCVar("cBanco",SE5->E5_BANCO)
                FIDC():setFIDCVar("cAgencia",SE5->E5_AGENCIA)
                FIDC():setFIDCVar("cConta",SE5->E5_CONTA)

            else

                cSA1IdxKey:="A1_FILIAL+A1_COD+A1_LOJA"

                SA1->(dbSetOrder(retOrder("SA1",cSA1IdxKey)))

                if (SA1->(MsSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA)))
                    nSA1RecNo:=SA1->(recNo())
                    FIDC():setFIDCVar("nSA1RecNo",nSA1RecNo)
                    FIDC():setFIDCVar("A1_YCDGREG",SA1->A1_YCDGREG)
                else
                    FIDC():setFIDCVar("A1_YCDGREG","")
                endif

                nSE1RecNo:=SE1->(recNo())

                FIDC():regrabcoIsFIDC(1)

                FIDC():setFIDCVar("nSE1RecNo",nSE1RecNo)
                FIDC():setFIDCVar("cBanco",SE1->E1_PORTADO)
                FIDC():setFIDCVar("cAgencia",SE1->E1_AGEDEP)
                FIDC():setFIDCVar("cConta",SE1->E1_CONTA)

            endif

        elseif (nType==2)

            if (stackTools():IsInCallStack("FINA050").or.stackTools():IsInCallStack("FINA090"))
                lCTBFIDC:=(SE5->E5_MOTBX=="FDC")
                if (lCTBFIDC)
                    break
                endif
            endif

            cSA2IdxKey:="A2_FILIAL+A2_COD+A2_LOJA"

            SA2->(dbSetOrder(retOrder("SA2",cSA2IdxKey)))

            if (SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA)))
                nSA2RecNo:=SA2->(recNo())
                FIDC():setFIDCVar("nSA2RecNo",nSA2RecNo)
                if (stackTools():IsInCallStack("U_FIDC0001").or.FIDC():isPGFIDC(.F.))
                    FIDC():setFIDCVar("A2_YCDGREG",SuperGetMV("MV_YCDGREA",.F.,"000030"))
                else
                    FIDC():setFIDCVar("E2_YCDGREG",SE2->E2_YCDGREG)
                endif
            else
                FIDC():setFIDCVar("A2_YCDGREG","")
                FIDC():setFIDCVar("E2_YCDGREG","")
            endif

            nSE2RecNo:=SE2->(recNo())

            FIDC():setFIDCVar("nSE2RecNo",nSE2RecNo)

            FIDC():regrabcoIsFIDC(2)

            FIDC():setFIDCVar("cBanco",SA6->A6_COD)
            FIDC():setFIDCVar("cAgencia",SA6->A6_AGENCIA)
            FIDC():setFIDCVar("cConta",SA6->A6_NUMCON)

        endif

        lbcoIsFIDC:=FIDC():bcoIsFIDC()
        FIDC():setFIDCVar("lbcoIsFIDC",lbcoIsFIDC)

        if (!lbcoIsFIDC)
            lCTBFIDC:=.F.
            break
        endif

        if (nType==1)

            lCTBFIDC:=stackTools():IsInCallStack("CleanBorSE1")
            if (lCTBFIDC)
                FIDC():setFIDCVar("cCTBStack","CleanBorSE1")
                break
            endif

            lCTBFIDC:=stackTools():IsInCallStack("ExecMovFin")
            if (lCTBFIDC)
                FIDC():setFIDCVar("cCTBStack","ExecMovFin")
                break
            endif

            lCTBFIDC:=stackTools():IsInCallStack("ExecBaixaCR")
            if (lCTBFIDC)
                FIDC():setFIDCVar("cCTBStack","ExecBaixaCR")
                break
            endif

        elseif (nType==2)

            aStack:=array(0)
            aAdd(aStack,"BAF002")
            aAdd(aStack,"PROCESS")
            aAdd(aStack,"ANALYZE")
            aAdd(aStack,"CONFIRM")
            aAdd(aStack,"BANKRECEIPT")

            lCTBFIDC:=stackTools():IsInStackCall(aStack)

            if (!lCTBFIDC)
                aSize(aStack,0)
                aAdd(aStack,"U_FIDC0001")
                lCTBFIDC:=stackTools():IsInStackCall(aStack)
                if (lCTBFIDC)
                    lCTBFIDC:=FIDC():isPGFIDC(.F.)
                    break
                endif
            else
                lCTBFIDC:=FIDC():isPGFIDC(.F.)
                break
            endif

        endif

        if (lCTBFIDC)
            lCTBFIDC:=lbcoIsFIDC
            if (!lCTBFIDC)
                break
            endif
        endif

        lCTBFIDC:=Stacktools():IsInCallStack("ctbFIDCOffLine")
        if (lCTBFIDC)
            if (stackTools():IsInCallStack("ctbFIDCOffLine"))
                FIDC():setFIDCVar("cCTBStack","ctbFIDCOffLine")
            endif
            if (stackTools():IsInCallStack("FINA070"))
                FIDC():setFIDCVar("cCTBStack","FINA070")
                FIDC():setFIDCVar("lFINA070",.T.)
            endif
        endif

    end sequence

    if (!lCTBFIDC)
        restArea(aAreaSA1)
        restArea(aAreaSA2)
        restArea(aAreaSA6)
        restArea(aAreaSE1)
        restArea(aAreaSE2)
        restArea(aAreaSE5)
        FWRestArea(aArea)
    endif

    return(lCTBFIDC)

static method isLPctbFIDC(cPadrao,nType) class FIDC

    local cPadraoLst    as character

    local lisLPctbFIDC  as logical

    paramtype cPadrao as character optional default FIDC():getFIDCVar("cPadrao","")
    paramtype nType as numeric optional default 1

    begin sequence

        cPadrao:=AllTrim(cPadrao)

        if (nType==1)

            lisLPctbFIDC:=(cPadrao$FIDC():getBiaPar("FIDC_LP_BAIXA","FBX"))
            if (lisLPctbFIDC)
                break
            endif

            lisLPctbFIDC:=(cPadrao$FIDC():getBiaPar("FIDC_LP_BORDERO","FBO"))
            if (lisLPctbFIDC)
                break
            endif

            cPadraoLst:="520,521,527"

        elseif (nType==2)

            cPadraoLst:="510"

        endif

        DEFAULT cPadraoLst:=""
        lisLPctbFIDC:=(cPadrao$cPadraoLst)
        if (lisLPctbFIDC)
            break
        endif

    end sequence

    return(lisLPctbFIDC)

static method ctbFIDCOffLine(nType) class FIDC

    local aArea             as array
    local aParamBox         as array
    local aParamRet         as array

    local aCT5Query         as array

    local bAction           as codeblock

    local cPadrao           as character
    local cLPFIDC           as character
    local cParamTit         as character

    local cCT5ilter         as character

    local dSvDataBase       as date

    local lPadrao           as logical
    local lParamBox         as logical
    local lctbFIDCOffLine   as logical

    local otMultProcess     as object

    paramtype nType as numeric optional default 1

    aArea:=FWGetArea()

    dSvDataBase:=&("dDataBase")

    saveInter()

    FIDC():resetFIDCVars()

    begin sequence

        if (nType==1)
            aParamBox:=CTBFIDCReceberParameters()
        elseif (nType==2)
            aParamBox:=CTBFIDCPagarParameters()
        else
            lctbFIDCOffLine:=.F.
            break
        endif

        cLPFIDC:=FIDC():getLPFIDC(nType)
        if (!empty(cLPFIDC))
            cCT5ilter:="CT5_LANPAD$'"+cLPFIDC+"'"
            aCT5Query:=array(0)
            MsAguarde({||FilBrowse("CT5",@aCT5Query,cCT5ilter)},"CTB FIDC","Filtrando LPs FIDC...")
        endif

        cParamTit:="CTB FIDC OffLine"
        lParamBox:=ParamBox(@aParamBox,@cParamTit,@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)

        if (!empty(cLPFIDC))
            EndFilBrw("CT5",@aCT5Query)
        endif

        if (!lParamBox)
            lctbFIDCOffLine:=lParamBox
            break
        endif

        cPadrao:=if((nType==1),aParamRet[5],if((nType==2),aParamRet[3],""))

        FIDC():setFIDCVar("cPadrao",cPadrao)

        lctbFIDCOffLine:=FIDC():isLPctbFIDC(cPadrao,nType)
        if (!lctbFIDCOffLine)
            ApMsgAlert("Lançamento Padrão ["+cPadrao+"] Inválido. Informe um LP válido para contabilização FIDC ["+if((nType==1),"RECEBER","PAGAR")+"]",cParamTit)
            break
        endif

        lPadrao:=verPadrao(cPadrao)
        if (!lPadrao)
            lctbFIDCOffLine:=.F.
            ApMsgAlert("Lançamento Padrão ["+cPadrao+"] Inválido. Informe um LP válido para contabilização FIDC ["+if((nType==1),"RECEBER","PAGAR")+"]",cParamTit)
            break
        endif

        bAction:={||lctbFIDCOffLine:=ctbFIDCOffLine(@otMultProcess,@aParamRet,@nType)}
        otMultProcess:=tMultProcess():New(bAction,cParamTit,"Aguarde. Contabilizando",nil,1)
        otMultProcess:Activate()

    end sequence

    FIDC():resetFIDCVars()

    restInter()

    &("dDataBase"):=dSvDataBase

    FWRestArea(aArea)

    return(lctbFIDCOffLine)

static function CTBFIDCReceberParameters() as array

    local aArea     as array
    local aParamBox as array

    local cPadraoBX as character

    local nPBoxAT   as numeric

    aArea:=FWGetArea()

    FIDC():resetFIDCVars()

    aParamBox:=array(0)

    //01----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Número Borderô De"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("E1_NUMBOR","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_NUMBOR","X3_PICTURE")//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_NUMBOR","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //02----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Número Borderô Ate"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("E1_NUMBOR","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_NUMBOR","X3_PICTURE")//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_NUMBOR","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //03----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Data Borderô De"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //04----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Data Borderô Ate"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //05----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Lançamento Padrão"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=FIDC():getBiaPar("FIDC_LP_BORDERO",Space(GetSx3Cache("CT5_LANPAD","X3_TAMANHO")))//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:=GetSx3Cache("CT5_LANPAD","X3_PICTURE")//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="ExistCpo('CT5')" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:="CT5"//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("CT5_LANPAD","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    cPadraoBX:=FIDC():getBiaPar("FIDC_LP_BAIXA","FBX")

    //06----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Data Retorno (Baixa)"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=Date()//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="'"+cPadraoBX+"'$MV_PAR05"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    FWRestArea(aArea)

    return(aParamBox)

static function CTBFIDCPagarParameters() as array

    local aArea     as array
    local aParamBox as array

    local nPBoxAT   as numeric

    aArea:=FWGetArea()

    FIDC():resetFIDCVars()

    aParamBox:=array(0)

   //01----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Baixa De"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //02----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Baixa Ate"//[2]:Descricao
    aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    //05----------------------------------------------------------------------------------------------
    aAdd(aParamBox,array(9))
    nPBoxAT:=Len(aParamBox)
    aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
    aParamBox[nPBoxAT][2]:="Lançamento Padrão"//[2]:Descricao
    aParamBox[nPBoxAT][3]:="510"//[3]:String contendo o inicializador do campo
    aParamBox[nPBoxAT][4]:=GetSx3Cache("CT5_LANPAD","X3_PICTURE")//[4]:String contendo a Picture do campo
    aParamBox[nPBoxAT][5]:="ExistCpo('CT5')" //[5]:String contendo a validacao
    aParamBox[nPBoxAT][6]:="CT5"//[6]:Consulta F3
    aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
    aParamBox[nPBoxAT][8]:=GetSx3Cache("CT5_LANPAD","X3_TAMANHO")//[8]:Tamanho do MsGet
    aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

    FWRestArea(aArea)

    return(aParamBox)

static function ctbFIDCOffLine(otMultProcess as object,aParamRet as array,nType as numeric) as logical

    local lctbFIDCOffLine as logical

    if (nType==1)
        lctbFIDCOffLine:=ctbFIDCReceber(@otMultProcess,@aParamRet)
    elseif (nType==2)
        lctbFIDCOffLine:=ctbFIDCPagar(@otMultProcess,@aParamRet)
    endif

    DEFAULT lctbFIDCOffLine:=.F.

    return(lctbFIDCOffLine)

static function ctbFIDCReceber(otMultProcess as object,aParamRet as array)

    local aSE1RecNos        as array
    local aZK4RecNos        as array

    local cPadrao           as character
    local cPadraoBX         as character

    local cTmpAlias         as character

    local cE1NUMBORDe       as character
    local cE1NUMBORAte      as character
    local cE1DATABORDe      as character
    local cE1DATABORAte     as character

    local cZK4Data          as character

    local dE1DATABORDe      as date
    local dE1DATABORAte     as date

    local dZK4Data          as date

    local lBaixa            as logical
    local lUsaFlag          as logical
    local lUsaSeqCor        as logical
    local lctbFIDCOffLine   as logical

    local nRecNo            as numeric
    local nRecNos           as numeric

    local nSA1RecNo         as numeric
    local nSE1RecNo         as numeric
    local nZK4RecNo         as numeric

    begin sequence

        cPadrao:=aParamRet[5]
        cPadraoBX:=FIDC():getBiaPar("FIDC_LP_BAIXA","FBX")

        cTmpAlias:=getNextAlias()

        lBaixa:=(cPadrao==cPadraoBX)
        if (lBaixa)

            cE1NUMBORDe:=Space(GetSX3Cache("E1_NUMBOR","X3_TAMANHO"))
            cE1NUMBORAte:=Replicate("Z",GetSX3Cache("E1_NUMBOR","X3_TAMANHO"))

            cE1DATABORDe:=Space(GetSX3Cache("E1_DATABOR","X3_TAMANHO"))
            cE1DATABORAte:=Replicate("Z",GetSX3Cache("E1_DATABOR","X3_TAMANHO"))

            dZK4Data:=aParamRet[6]
            cZK4Data:=DToS(dZK4Data)

            beginSQL alias cTmpAlias

                %noparser%

                SELECT SE1.R_E_C_N_O_ SE1RECNO
                      ,ZK4.R_E_C_N_O_ ZK4RECNO
                      ,SA1.R_E_C_N_O_ SA1RECNO
                  FROM %table:SE1% SE1 (NOLOCK)
                  JOIN %table:ZK4% ZK4 (NOLOCK)
                    ON (
                            SE1.E1_PORTADO=ZK4.ZK4_BANCO
                        AND SE1.E1_AGEDEP=ZK4.ZK4_AGENCI
                        AND SE1.E1_CONTA=ZK4.ZK4_CONTA
                        AND SE1.E1_NUM+E1_PARCELA=ZK4.ZK4_NUMERO
                        AND SE1.E1_NUMBCO=SUBSTRING(ZK4.ZK4_NOSNUM,1,11)
                        AND SE1.E1_VENCTO<=ZK4.ZK4_DTVENC
                    )
                    ,%table:SA6% SA6 (NOLOCK)
                    ,%table:SA1% SA1 (NOLOCK)
                WHERE SE1.%notDel%
                  AND ZK4.%notDel%
                  AND SA1.%notDel%
                  AND SE1.E1_FILIAL=%xFilial:SE1%
                  AND ZK4.ZK4_FILIAL=%xFilial:ZK4%
                  AND SA1.A1_FILIAL=%xFilial:SA1%
                  AND ZK4.ZK4_DATA=%exp:cZK4Data%
                  AND ZK4.ZK4_CODOCO='06'
                  AND ZK4.ZK4_TIPO='R'
                  AND SE1.E1_LA<>'S'
                  AND SE1.E1_PORTADO=SA6.A6_COD
                  AND SE1.E1_CONTA=SA6.A6_NUMCON
                  AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
                  AND SE1.E1_NUMBOR BETWEEN %exp:cE1NUMBORDe% AND %exp:cE1NUMBORAte%
                  AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
                  AND SA6.%notDel%
                  AND SA6.A6_FILIAL=%xFilial:SA6%
                  AND SA6.A6_YTPINTB='1'
                  AND SE1.E1_YSITAPI='2'
                  AND SA1.A1_COD=SE1.E1_CLIENTE
                  AND SA1.A1_LOJA=SE1.E1_LOJA

            endSQL

        else

            cE1NUMBORDe:=aParamRet[1]
            cE1NUMBORAte:=aParamRet[2]

            dE1DATABORDe:=aParamRet[3]
            dE1DATABORAte:=aParamRet[4]

            cE1DATABORDe:=DToS(dE1DATABORDe)
            cE1DATABORAte:=DToS(dE1DATABORAte)

            beginSQL alias cTmpAlias
                
                %noparser%
                
                SELECT SE1.R_E_C_N_O_ SE1RECNO
                      ,SA1.R_E_C_N_O_ SA1RECNO
                  FROM %table:SE1% SE1 (NOLOCK)
                         ,%table:SA6% SA6 (NOLOCK)
                      ,%table:SA1% SA1 (NOLOCK)
                 WHERE SE1.%notDel%
                   AND SA6.%notDel%
                   AND SA1.%notDel%
                   AND SE1.E1_FILIAL=%xFilial:SE1%
                   AND SE1.E1_LA<>'S'
                   AND SE1.E1_PORTADO=SA6.A6_COD
                   AND SE1.E1_CONTA=SA6.A6_NUMCON
                   AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
                   AND SE1.E1_NUMBOR BETWEEN %exp:cE1NUMBORDe% AND %exp:cE1NUMBORAte%
                   AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
                   AND SA6.A6_FILIAL=%xFilial:SA6%
                   AND SA6.A6_YTPINTB='1'
                   AND SE1.E1_YSITAPI='2'
                   AND SA1.A1_FILIAL=%xFilial:SA1%
                   AND SA1.A1_COD=SE1.E1_CLIENTE
                   AND SA1.A1_LOJA=SE1.E1_LOJA
            
            endSQL

        endif

        aSE1RecNos:=array(0)
        if (lBaixa)
            aZK4RecNos:=array(0)
        endif

        while (cTmpAlias)->(!eof())
            nSE1RecNo:=(cTmpAlias)->SE1RECNO
            nSA1RecNo:=(cTmpAlias)->SA1RECNO
            aAdd(aSE1RecNos,{nSE1RecNo,nSA1RecNo})
            if (lBaixa)
                nZK4RecNo:=(cTmpAlias)->ZK4RECNO
                aAdd(aZK4RecNos,nZK4RecNo)
            endif
            (cTmpAlias)->(dbSkip())
        end while

        (cTmpAlias)->(dbCloseArea())
        dbSelectArea("SE1")

        nRecNos:=Len(aSE1RecNos)
        otMultProcess:SetRegua(1,nRecNos)

        lUsaFlag:=SuperGetMV("MV_CTBFLAG",.F./*lHelp*/,.F./*DEFAULT*/)
        lUsaSeqCor:=FindFunction("UsaSeqCor")

        for nRecNo:=1 to nRecNos
            otMultProcess:IncRegua(1,"FIDC :: Contabilizando ["+cPadrao+"]. Aguarde...")
            nSE1RecNo:=aSE1RecNos[nRecNo][1]
            SE1->(dbGoTo(nSE1RecNo))
            nSA1RecNo:=aSE1RecNos[nRecNo][2]
            SA1->(MsGoTo(nSA1RecNo))
            if (lBaixa)
                nZK4RecNo:=aZK4RecNos[nRecNo]
                ZK4->(dbGoTo(nZK4RecNo))
                &("dDataBase"):=ZK4->ZK4_DTLIQ
            else
                &("dDataBase"):=SE1->E1_DATABOR
            endif
            FIDC():setFIDCVar("lCTBFIDC",.T.)
            FIDC():setFIDCVar("cCTBStack","ctbFIDCOffLine")
            FIDC():setFIDCVar("cPadrao",cPadrao)
            FIDC():setFIDCVar("nSE1RecNo",nSE1RecNo)
            FIDC():setFIDCVar("nSA1RecNo",nSA1RecNo)
            FIDC():setFIDCVar("cBanco",SE1->E1_PORTADO)
            FIDC():setFIDCVar("cAgencia",SE1->E1_AGEDEP)
            FIDC():setFIDCVar("cConta",SE1->E1_CONTA)
            FIDC():setFIDCVar("lUsaFlag",lUsaFlag)
            if (FIDC():getFIDCVar("lUsaFlag",.F.))
                FIDC():setFIDCVar("aFlagCTB",{"E1_LA","S","SE1",nSE1RecNo,0,0,0})
            endif
            FIDC():setFIDCVar("lDiario",(lUsaSeqCor.and.UsaSeqCor()))
            if (FIDC():getFIDCVar("lDiario",.F.))
                FIDC():setFIDCVar("aDiario",{"SE1",nSE1RecNo,SE1->E1_DIACTB,"E1_NODIA","E1_DIACTB"})
            endif
            SE1->(FIDC():ctbFIDC(1))
            FIDC():resetFIDCVars()
        next nRecNo

        lctbFIDCOffLine:=.T.

    end sequence

    return(lctbFIDCOffLine)

static function ctbFIDCPagar(otMultProcess as object,aParamRet as array)

    local aSE2RecNos        as array

    local cPadrao           as character

    local cTmpAlias         as character

    local cE2BAIXADe        as character
    local cE2BAIXAAte       as character

    local cJSONFIDC         as character
    local cJSONOrigem       as character 

    local cFI8KeySource     as character
    local cFIDCExpFilter    as character
 
    local dE2BAIXADe        as date
    local dE2BAIXAAte       as date

    local lUsaFlag          as logical
    local lUsaSeqCor        as logical
    local lFI8KeySource     as logical
    local lctbFIDCOffLine   as logical

    local nRecNo            as numeric
    local nRecNos           as numeric

    local nTotalCTB         as numeric

    local nSA2RecNo         as numeric
    local nSE2RecNo         as numeric
    local nFI8RecNo         as numeric

    local oCPStruct         as object

    local oJSONFIDC         as object
    local oJSONOrigem       as object 

    begin sequence

        cPadrao:=aParamRet[3]

        cTmpAlias:=getNextAlias()

        dE2BAIXADe:=aParamRet[1]
        dE2BAIXAAte:=aParamRet[2]

        cE2BAIXADe:=DToS(dE2BAIXADe)
        cE2BAIXAAte:=DToS(dE2BAIXAAte)

        cFIDCExpFilter:="("
        cFIDCExpFilter+="   (E2_YANTTX>0) AND (E2_YANTDES>0)"
        cFIDCExpFilter+="   OR "
        cFIDCExpFilter+="   ("
        cFIDCExpFilter+="   SELECT ISNULL(t.FIDC,0) FIDC" 
        cFIDCExpFilter+="       FROM ("
        cFIDCExpFilter+="                SELECT DISTINCT 1 AS FIDC"
        cFIDCExpFilter+="                  FROM "+RetSQLName("SE5")+" SE5 (NOLOCK)"
        cFIDCExpFilter+="                 WHERE SE5.D_E_L_E_T_=''" 
        cFIDCExpFilter+="                   AND SE5.E5_FILIAL=E2_FILIAL"
        cFIDCExpFilter+="                   AND SE5.E5_PREFIXO=E2_PREFIXO"
        cFIDCExpFilter+="                   AND SE5.E5_NUMERO=E2_NUM"
        cFIDCExpFilter+="                   AND SE5.E5_PARCELA=E2_PARCELA"
        cFIDCExpFilter+="                   AND SE5.E5_CLIFOR=E2_FORNECE"
        cFIDCExpFilter+="                   AND SE5.E5_LOJA=E2_LOJA"
        cFIDCExpFilter+="                   AND SE5.E5_MOTBX='FDC'"
        cFIDCExpFilter+="                   AND SE5.E5_DTCANBX=''"
        cFIDCExpFilter+="   ) t )=1"
        cFIDCExpFilter+=")"

        cFIDCExpFilter:="%"+cFIDCExpFilter+"%"

        beginSQL alias cTmpAlias
            
            %noparser%
            
            SELECT SE2.R_E_C_N_O_ SE2RECNO
                  ,SA2.R_E_C_N_O_ SA2RECNO
                FROM %table:SE2% SE2
                JOIN SA2010 SA2 ON (
                    SE2.E2_FORNECE=SA2.A2_COD
                AND SE2.E2_LOJA=SA2.A2_LOJA
                )
                WHERE SE2.%notDel%
                  AND SA2.%notDel%
                  AND SE2.E2_FILIAL=%xFilial:SE2%
                  AND SA2.A2_FILIAL=%xFilial:SA2%
                  AND SE2.E2_LA = ''
                  AND SE2.E2_BAIXA   BETWEEN %exp:cE2BAIXADe% AND %exp:cE2BAIXAAte%
                  AND SE2.E2_YSITAPI='2'
                  AND (%exp:cFIDCExpFilter%)
        
        endSQL

        aSE2RecNos:=array(0)

        while (cTmpAlias)->(!eof())
            nSE2RecNo:=(cTmpAlias)->SE2RECNO
            nSA2RecNo:=(cTmpAlias)->SA2RECNO
            aAdd(aSE2RecNos,{nSE2RecNo,nSA2RecNo})
            (cTmpAlias)->(dbSkip())
        end while

        (cTmpAlias)->(dbCloseArea())
        dbSelectArea("SE2")

        nRecNos:=Len(aSE2RecNos)
        otMultProcess:SetRegua(1,nRecNos)

        lUsaFlag:=SuperGetMV("MV_CTBFLAG",.F./*lHelp*/,.F./*DEFAULT*/)
        lUsaSeqCor:=FindFunction("UsaSeqCor")

        oCPStruct:=TContaPagarStruct():New()
        
        oJSONFIDC:=JSONArray():New()
        oJSONOrigem:=JSONArray():New()

        for nRecNo:=1 to nRecNos
            
            otMultProcess:IncRegua(1,"FIDC :: Contabilizando ["+cPadrao+"]. Aguarde...")
            
            nSE2RecNo:=aSE2RecNos[nRecNo][1]
            SE2->(dbGoTo(nSE2RecNo))

            nSA2RecNo:=aSE2RecNos[nRecNo][2]
            SA2->(MsGoTo(nSA2RecNo))

            cFI8KeySource:=SE2->E2_FILIAL
            cFI8KeySource+=SE2->E2_PREFIXO
            cFI8KeySource+=SE2->E2_NUM
            cFI8KeySource+=SE2->E2_PARCELA
            cFI8KeySource+=SE2->E2_TIPO
            cFI8KeySource+=SE2->E2_FORNECE
            cFI8KeySource+=SE2->E2_LOJA

            lFI8KeySource:=FI8->(dbSeek(cFI8KeySource,.F.))
            if (!lFI8KeySource)
                loop
            endif

            nFI8RecNo:=FI8->(recNo())

            SE2->(MsGoTo(nSE2RecNo))

            oCPStruct:cPrefixo:=SE2->E2_PREFIXO
            oCPStruct:cNumero:=SE2->E2_NUM
            oCPStruct:cParcela:=SE2->E2_PARCELA
            oCPStruct:cTipo:=SE2->E2_TIPO
            oCPStruct:cNatureza:=SE2->E2_NATUREZ
            oCPStruct:cFornecedor:=SE2->E2_FORNECE
            oCPStruct:cLoja:=SE2->E2_LOJA
            oCPStruct:dEmissao:=SE2->E2_EMISSAO
            oCPStruct:dVencto:=SE2->E2_VENCTO

            cJSONOrigem:=oJSONOrigem:toJSON(oCPStruct)
            oJSONOrigem:fromJSON(cJSONOrigem)
            
            cacheData():Set("FIDC0001","ORIGEM",oJSONOrigem)
            cacheData():Set("FIDC0001","nSA2RecNoOrigem",nSA2RecNo)
            cacheData():Set("FIDC0001","nSE2RecNoOrigem",nSE2RecNo)
            cacheData():Set("FIDC0001","nFI8RecNoOrigem",nFI8RecNo)

            FI8->(MsGoTo(nFI8RecNo))

            oCPStruct:cPrefixo:=FI8->FI8_PRFDES
            oCPStruct:cNumero:=FI8->FI8_NUMDES
            oCPStruct:cParcela:=FI8->FI8_PARDES
            oCPStruct:cTipo:=FI8->FI8_TIPDES
            oCPStruct:cNatureza:="2990"
            oCPStruct:cFornecedor:=FI8->FI8_FORDES
            oCPStruct:cLoja:=FI8->FI8_LOJDES
            oCPStruct:dEmissao:=FI8->FI8_DATA
            oCPStruct:dVencto:=SE2->E2_VENCTO

            cJSONFIDC:=oJSONFIDC:toJSON(oCPStruct)
            oJSONFIDC:fromJSON(cJSONFIDC)
            
            cacheData():Set("FIDC0001","FIDC",oJSONFIDC)

            SE2->(MsGoTo(nSE2RecNo))

            &("dDataBase"):=SE2->E2_BAIXA
        
            FIDC():setFIDCVar("lCTBFIDC",.T.)
            FIDC():setFIDCVar("cCTBStack","ctbFIDCOffLine")
            FIDC():setFIDCVar("cPadrao",cPadrao)
            FIDC():setFIDCVar("nSE2RecNo",nSE2RecNo)
            FIDC():setFIDCVar("nSA2RecNo",nSA2RecNo)

            if (FIDC():isPGFIDC(.F.))
                FIDC():setFIDCVar("A2_YCDGREG",SuperGetMV("MV_YCDGREA",.F.,"000030"))
            else
                FIDC():setFIDCVar("E2_YCDGREG",SE2->E2_YCDGREG)
            endif

            FIDC():regrabcoIsFIDC(2)

            FIDC():setFIDCVar("cBanco",SA6->A6_COD)
            FIDC():setFIDCVar("cAgencia",SA6->A6_AGENCIA)
            FIDC():setFIDCVar("cConta",SA6->A6_NUMCON)

            FIDC():setFIDCVar("lUsaFlag",lUsaFlag)
        
            if (FIDC():getFIDCVar("lUsaFlag",.F.))
                FIDC():setFIDCVar("aFlagCTB",{"E2_LA","S","SE2",nSE2RecNo,0,0,0})
            endif
        
            FIDC():setFIDCVar("lDiario",(lUsaSeqCor.and.UsaSeqCor()))
        
            if (FIDC():getFIDCVar("lDiario",.F.))
                FIDC():setFIDCVar("aDiario",{"SE2",nSE2RecNo,SE2->E2_DIACTB,"E2_NODIA","E2_DIACTB"})
            endif
        
            if (SE2->((E2_LA=='S').or.empty(E2_LA)))
                if (SE2->(recLock("SE2",.F.)))
                    SE2->E2_LA:='N'
                    SE2->(msUnLock())
                endif
            endif
            
            nTotalCTB:=SE2->(FIDC():ctbFIDC(2))
            
            if (nTotalCTB)
                
                SE2->(MsGoTo(nSE2RecNo))
                
                if (SE2->((E2_LA=='N').or.empty(E2_LA)))
                    if (SE2->(recLock("SE2",.F.)))
                        SE2->E2_LA:="S"
                        SE2->(msUnLock())
                    endif
                endif
                
                FI8->(MsGoTo(nFI8RecNo))            
                
                SE2->(dbSetOrder(retOrder("SE2","E2_FILIAL+E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA")))
                
                if (SE2->(dbSeek(xFilial("SE2")+FI8->(FI8_PRFDES+FI8_NUMDES+FI8_PARDES+FI8_TIPDES+FI8_FORDES+FI8_LOJDES),.F.)))
                    if (SE2->((E2_LA=='N').or.empty(E2_LA)))
                        if (SE2->(recLock("SE2",.F.)))
                            SE2->E2_LA:="S"
                            SE2->(msUnLock())
                        endif
                    endif
                endif
            
            endif

            FIDC():resetFIDCVars()
        
        next nRecNo

        cacheData():delSection("FIDC0001")

        lctbFIDCOffLine:=.T.

    end sequence

    return(lctbFIDCOffLine)

static method txFIDCOffLine() class FIDC

    local aArea             as array
    local aParamBox         as array
    local aParamRet         as array

    local bAction           as codeblock

    local cParamTit         as character

    local lParamBox         as logical
    local ltxFIDCOffLine    as logical

    local nPBoxAT           as numeric

    local otMultProcess     as object

    aArea:=FWGetArea()

    saveInter()

    FIDC():resetFIDCVars()

    begin sequence

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:="Número Borderô De"//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("E1_NUMBOR","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_NUMBOR","X3_PICTURE")//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_NUMBOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:="Número Borderô Ate"//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("E1_NUMBOR","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_NUMBOR","X3_PICTURE")//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_NUMBOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:="Data Borderô De"//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_EMISSAO","X3_PICTURE")//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:="Data Borderô Ate"//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=GetSx3Cache("E1_EMISSAO","X3_PICTURE")//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        cParamTit:="Taxa FIDC OffLine"
        lParamBox:=ParamBox(@aParamBox,@cParamTit,@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)

        if (!lParamBox)
            ltxFIDCOffLine:=lParamBox
            break
        endif

        bAction:={||ltxFIDCOffLine:=txFIDCOffLine(otMultProcess,aParamRet)}
        otMultProcess:=tMultProcess():New(bAction,cParamTit,"Aguarde. Atualizando Taxa...",nil,1)
        otMultProcess:Activate()

    end sequence

    FIDC():resetFIDCVars()

    restInter()

    FWRestArea(aArea)

    return(ltxFIDCOffLine)

static function txFIDCOffLine(otMultProcess as object,aParamRet as array) as logical

    local aSE1RecNos        as array

    local cTmpAlias         as character

    local cE1NUMBORDe       as character
    local cE1NUMBORAte      as character
    local cE1DATABORDe      as character
    local cE1DATABORAte     as character

    local dE1DATABORDe      as date
    local dE1DATABORAte     as date

    local ltxFIDCOffLine    as logical

    local nRecNo            as numeric
    local nRecNos           as numeric
    local nSE1RecNo         as numeric

    begin sequence

        cE1NUMBORDe:=aParamRet[1]
        cE1NUMBORAte:=aParamRet[2]

        dE1DATABORDe:=aParamRet[3]
        dE1DATABORAte:=aParamRet[4]

        cE1DATABORDe:=DToS(dE1DATABORDe)
        cE1DATABORAte:=DToS(dE1DATABORAte)

        cTmpAlias:=getNextAlias()

        beginSQL alias cTmpAlias
            
            %noparser% 
            
            SELECT SE1.R_E_C_N_O_ SE1RECNO
            FROM %table:SE1% SE1 (NOLOCK)
                ,%table:SA6% SA6 (NOLOCK)
            WHERE SE1.%notDel%
              AND SE1.E1_FILIAL=%xFilial:SE1%
              AND SE1.E1_PORTADO=SA6.A6_COD
              AND SE1.E1_CONTA=SA6.A6_NUMCON
              AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
              AND SE1.E1_NUMBOR BETWEEN %exp:cE1NUMBORDe% AND %exp:cE1NUMBORAte%
              AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
              AND SA6.%notDel%
              AND SA6.A6_FILIAL=%xFilial:SA6%
              AND SA6.A6_YTPINTB='1'
        
        endSQL

        aSE1RecNos:=array(0)

        while (cTmpAlias)->(!eof())
            nSE1RecNo:=(cTmpAlias)->SE1RECNO
            aAdd(aSE1RecNos,nSE1RecNo)
            (cTmpAlias)->(dbSkip())
        end while

        (cTmpAlias)->(dbCloseArea())
        dbSelectArea("SE1")

        nRecNos:=Len(aSE1RecNos)
        otMultProcess:SetRegua(1,nRecNos)

        for nRecNo:=1 to nRecNos
            otMultProcess:IncRegua(1,"FIDC :: Atualizando Taxa. Aguarde...")
            nSE1RecNo:=aSE1RecNos[nRecNo]
            SE1->(dbGoTo(nSE1RecNo))
            if SE1->(recLock("SE1",.F.))
                FIDC():setFIDCVar("cBanco",SE1->E1_PORTADO)
                FIDC():setFIDCVar("cAgencia",SE1->E1_AGEDEP)
                FIDC():setFIDCVar("cConta",SE1->E1_CONTA)
                if (FIDC():bcoIsFIDC())
                    SE1->E1_YFDCPER:=FIDC():percentualDesconto()
                    SE1->E1_YFDCVAL:=FIDC():calculaDesconto(SE1->E1_VALOR+SE1->E1_YTXCOBR,SE1->E1_VENCTO,SE1->E1_DATABOR)
                endif
                SE1->(msUnLock())
            endif
        next nRecNo

        ltxFIDCOffLine:=.T.

    end sequence

    return(ltxFIDCOffLine)

static method setFIDCVar(uVar,uVal) class FIDC
    FIDCVarsInit()
    return(oFIDCVars:Set(uVar,uVal))

static method getFIDCVar(uVar,uDefault) class FIDC
    FIDCVarsInit()
    return(oFIDCVars:Get(uVar,uDefault))

static method resetFIDCVars() class FIDC
    FIDCVarsInit()
    return(oFIDCVars:Clear())

static function FIDCVarsInit()
    DEFAULT oFIDCVars:=JSONArray():New()
    return(oFIDCVars)

static method percentualDesconto(cEmp,cFil) class FIDC
    local nPercentualDesconto as numeric
    paramtype cEmp as character optional
    paramtype cFil as character optional
    cEmp:=PadR(cEmp,getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    cFil:=PadR(cFil,getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))
    nPercentualDesconto:=FIDC():getBiaPar("FIDC_PERCENTUAL_DESCONTO",0,cEmp,cFil)
    nPercentualDesconto/=100
    return(nPercentualDesconto)

static method calculaDesconto(nValor,dVencimento,dReferencia) class FIDC

    local dToday            as date
    local dDataValida       as date

    local nDiasCalculo      as numeric
    local nFatorCalculo     as numeric
    local nValorDesconto    as numeric
    local nFIDCPercentual   as numeric

    paramtype nValor        as numeric
    paramtype dVencimento   as date
    paramtype dReferencia   as date optional

    dToday:=Date()
    DEFAULT dReferencia:=dToday

    nFIDCPercentual:=FIDC():percentualDesconto()
    FIDC():setFIDCVar("nFIDCPercentual",nFIDCPercentual)

    dDataValida:=DataValida(DataValida(dVencimento)+1)
    FIDC():setFIDCVar("dDataValida",dDataValida)

    nDiasCalculo:=(dDataValida-dReferencia)
    FIDC():setFIDCVar("nDiasCalculo",nDiasCalculo)

    nFatorCalculo:=(((nFIDCPercentual+1)^(nDiasCalculo/30))-1)
    FIDC():setFIDCVar("nFatorCalculo",nFatorCalculo)

    nValorDesconto:=(nValor*nFatorCalculo)
    nValorDesconto:=Round(nValorDesconto,2)
    FIDC():setFIDCVar("nValorDesconto",nValorDesconto)

    return(nValorDesconto)

static method getBiaPar(cParam,xDefault,cEmp,cFil) class FIDC

    local cFIDCPar as character

    local uRet

    paramtype cParam as character
    paramtype cEmp as character optional
    paramtype cFil as character optional

    FIDCParsInit()

    cParam:=PadR(cParam,getSX3Cache("ZL4_PARAM","X3_TAMANHO"))

    cEmp:=PadR(cEmp,getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    cFil:=PadR(cFil,getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))

    cFIDCPar:=(cEmp+cFil+cParam)

    if ((!stackTools():IsInCallStack("existBiaPar")).and.FIDC():existBiaPar(cParam,cEmp,cFil,xDefault))
        uRet:=oFIDCPars:Get(cFIDCPar,xDefault)
    else
        uRet:=U_GETBIAPAR(@cParam,@xDefault,@cEmp,@cFil)
        oFIDCPars:Set(cFIDCPar,uRet)
    endif

    return(uRet)

static method putBiaPar(cParam,cConteudo,cEmp,cFil) class FIDC

    paramtype cParam as character
    paramtype cConteudo as character
    paramtype cEmp as character optional
    paramtype cFil as character optional

    FIDCParsInit()

    cParam:=PadR(cParam,getSX3Cache("ZL4_PARAM","X3_TAMANHO"))

    cEmp:=PadR(cEmp,getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    cFil:=PadR(cFil,getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))

    return(U_PUTBIAPAR(@cParam,@cConteudo,@cEmp,@cFil))

static method existBiaPar(cParam,cEmp,cFil,xDefault) class FIDC

    local aArea         as array

    local cAlias        as character
    local cZL4CODEMP    as character
    local cZL4CODFIL    as character

    local cFIDCPar      as character

    local lexistBiaPar  as logical

    local nZL4RecNo     as numeric

    local uValue

    paramtype cParam as character
    paramtype cEmp as character optional default Space(getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    paramtype cFil as character optional default Space(getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))

    cEmp:=PadR(cEmp,getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    cFil:=PadR(cFil,getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))
    cParam:=PadR(cParam,getSX3Cache("ZL4_PARAM","X3_TAMANHO"))

    FIDCParsInit()

    begin sequence

        cFIDCPar:=(cEmp+cFil+cParam)

        lexistBiaPar:=(oFIDCPars:GetAT(cFIDCPar)>0)
        if (lexistBiaPar)
            break
        endif

        aArea:=FWGetArea()

        cAlias:=getNextAlias()

        beginSQL alias cAlias

            %noparser%

            SELECT ZL4.R_E_C_N_O_ ZL4RECNO
              FROM %table:ZL4% ZL4
             WHERE ZL4.%notDel%
               AND ZL4.ZL4_FILIAL=%xFilial:ZL4%
               AND (
                           (ZL4.ZL4_CODEMP=%exp:cEmp% AND ZL4.ZL4_CODFIL=%exp:cFil%)
                        OR
                        (ZL4.ZL4_CODEMP=%exp:cEmp% AND ZL4.ZL4_CODFIL=' ')
                        OR
                        (ZL4.ZL4_CODEMP=' ' AND ZL4.ZL4_CODFIL=%exp:cFil%)
               )

        endSQL

        while (cAlias)->(!eof())
            nZL4RecNo:=(cAlias)->ZL4RECNO
            ZL4->(dbGoTo(nZL4RecNo))
            cZL4CODEMP:=ZL4->ZL4_CODEMP
            cZL4CODFIL:=ZL4->ZL4_CODFIL
            uValue:=FIDC():getBiaPar(cParam,xDefault,cZL4CODEMP,cZL4CODFIL)
            cFIDCPar:=(cZL4CODEMP+cZL4CODFIL+cParam)
            oFIDCPars:Set(cFIDCPar,uValue)
            (cAlias)->(dbSkip())
        end while

        (cAlias)->(dbCloseArea())

        FWRestArea(aArea)

        cFIDCPar:=(cEmp+cFil+cParam)
        lexistBiaPar:=(oFIDCPars:GetAT(cFIDCPar)>0)

    end sequence

    return(lexistBiaPar)

static method InsertBiaPar(cParam,cConteudo,cEmp,cFil) class FIDC

    local lInsertBiaPar as logical

    paramtype cParam as character
    paramtype cConteudo as character
    paramtype cEmp as character optional
    paramtype cFil as character optional

    FIDCParsInit()

    cEmp:=PadR(cEmp,getSX3Cache("ZL4_CODEMP","X3_TAMANHO"))
    cFil:=PadR(cFil,getSX3Cache("ZL4_CODFIL","X3_TAMANHO"))
    cParam:=PadR(cParam,getSX3Cache("ZL4_PARAM","X3_TAMANHO"))

    lInsertBiaPar:=FIDC():existBiaPar(@cParam,@cEmp,@cFil)
    if (!lInsertBiaPar)
        //TODO: Implementar a inclusao de parametros
    endif

    return(lInsertBiaPar)

static method resetFIDCPars() class FIDC
    FIDCParsInit()
    return(oFIDCPars:Clear())

static function FIDCParsInit()
    DEFAULT oFIDCPars:=JSONArray():New()
    return(oFIDCPars)

static method getRecQueryRem(aParamRet,abcoIsFIDC,aFWTTables) class FIDC

    local aFields           as array

    local bError            as codeblock
    local bErrorBlock       as codeblock

    local cTmpAlias         as character
    local cTmpTable         as character
    local cAPITable         as character

    local cA6COD            as character
    local cA6AGENCIA        as character
    local cA6NUMCON         as character

    local cA1CODDe          as character
    local cA1CODAte         as character

    local cE1DATABORDe      as character
    local cE1DATABORAte     as character

    local cE1EMISSAODe      as character
    local cE1EMISSAOAte     as character

    local cE1VENCTODe       as character
    local cE1VENCTOAte      as character

    local cUnidadeCodigo    as character

    local cSQLPath          as character
    local cSQLFile          as character
    local cSQLQuery         as character
    local cSQLInsert        as character

    local cField            as character
    local cSQLFields        as character

    local nField            as numeric
    local nFields           as numeric

    local oFWTTable         as object

    paramtype aParamRet as array
    paramtype abcoIsFIDC as array

    paramtype aFWTTables as array optional default array(0)

    cA6COD:=abcoIsFIDC[3]
    cA6AGENCIA:=abcoIsFIDC[4]
    cA6NUMCON:=abcoIsFIDC[5]

    cA1CODDe:=aParamRet[1]
    cA1CODAte:=aParamRet[2]

    cE1DATABORDe:=DToS(aParamRet[3])
    cE1DATABORAte:=DToS(aParamRet[4])

    cE1EMISSAODe:=DToS(aParamRet[5])
    cE1EMISSAOAte:=DToS(aParamRet[6])

    cE1VENCTODe:=DToS(aParamRet[7])
    cE1VENCTOAte:=DToS(aParamRet[8])

    cAPITable:=A35():tmpTableName("api_table")
    cAPITable:="%"+cAPITable+"%"

    cTmpAlias:=getNextAlias()

    cUnidadeCodigo:=&("cEmpAnt")
    cUnidadeCodigo+=&("cFilAnt")

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    bError:={|oError|break(oError)}
    bErrorBlock:=ErrorBlock(bError)
    begin sequence

        beginSQL Alias cTmpAlias

            %noparser%

            WITH QAPI AS (
                                SELECT SE1RECNO=NumeroControleParticipante
                                  FROM APIFINANCEIRO.dbo.Boleto  (NOLOCK)
                                  JOIN APIFINANCEIRO.dbo.Unidade (NOLOCK) ON (Unidade.ID=Boleto.UnidadeID)
                                  JOIN APIFINANCEIRO.dbo.Lote    (NOLOCK) ON (Lote.ID = Boleto.LoteID)
                                  JOIN APIFINANCEIRO.dbo.Cedente (NOLOCK) ON (Cedente.ID=Boleto.CedenteID)
                                  JOIN APIFINANCEIRO.dbo.ContaBancaria (NOLOCK) ON (ContaBancaria.ID=Cedente.ContaBancariaID)
                                    WHERE CodigoBanco=%exp:cA6COD%
                                      AND Agencia=%exp:cA6AGENCIA%
                                      AND Conta=%exp:cA6NUMCON%
                                      AND NomeArquivo<>''
                                      AND Unidade.Codigo=%exp:cUnidadeCodigo%
                                      AND CONVERT(DATE,APIFINANCEIRO.dbo.Boleto.InsertDate) BETWEEN CONVERT(DATE,%exp:cE1DATABORDe%) AND CONVERT(DATE,%exp:cE1DATABORAte%)
            )
            SELECT * INTO %exp:cAPITable% FROM QAPI

        endSQL

    end sequence
    ErrorBlock(bErrorBlock)

    cSQLQuery:=getLastQuery()[2]
    TCSQLExec(cSQLQuery)

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRemessa","00","qry_insert",@cSQLPath,@cSQLFile)

    if (select(cTmpAlias)>0)
        (cTmpAlias)->(dbCloseArea())
    endif

    cSQLFields:=""
    cSQLFields+="SA1.A1_COD"
    cSQLFields+=",SA1.A1_NOME"
    cSQLFields+=",SE1.E1_DATABOR"
    cSQLFields+=",(CASE SE1.E1_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E1_PREFIXO","X3_TAMANHO"))+"' ELSE SE1.E1_PREFIXO END)+SE1.E1_NUM+SE1.E1_PARCELA AS P_NUM_PARC"
    cSQLFields+=",SE1.E1_EMISSAO"
    cSQLFields+=",SE1.E1_VENCTO"
    cSQLFields+=",0  AS DIAS_ANTEC"
    cSQLFields+=",'' AS E1_VENCREA"
    cSQLFields+=",SE1.E1_VALOR"
    cSQLFields+=",SE1.E1_YFDCVAL"
    cSQLFields+=",SE1.E1_NUMBCO"

    if (stackTools():IsInCallStack("getRecQueryCon"))
        cSQLFields+=",SE1.R_E_C_N_O_ AS SE1RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E1_DATABOR  AS DATE
        COLUMN E1_EMISSAO  AS DATE
        COLUMN E1_VENCTO   AS DATE
        COLUMN E1_VENCREA  AS DATE

        SELECT %exp:cSQLFields%
          FROM %table:SE1% SE1 (NOLOCK)
          JOIN %exp:cAPITable% QAPI ON (SE1.R_E_C_N_O_=QAPI.SE1RECNO)
          JOIN %table:SA1% SA1 (NOLOCK) ON (
                SA1.%notDel%
           AND SA1.A1_FILIAL=%xFilial:SA1%
           AND SE1.E1_CLIENTE=SA1.A1_COD
           AND SE1.E1_LOJA=SA1.A1_LOJA
          )
          JOIN %table:SA6% SA6 (NOLOCK) ON (
                SA6.%notDel%
           AND SA6.A6_FILIAL=%xFilial:SA6%
           AND SA6.A6_COD=%exp:cA6COD%
           AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
           AND SA6.A6_NUMCON=%exp:cA6NUMCON%
           AND SE1.E1_PORTADO=SA6.A6_COD
           AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
           AND SE1.E1_CONTA=SA6.A6_NUMCON
           AND SA6.A6_YTPINTB='1'
          )
         WHERE (1=2)
           AND SE1.%notDel%
           AND SA1.%notDel%
           AND SA6.%notDel%
           AND SE1.E1_FILIAL=%xFilial:SE1%
           AND SA1.A1_FILIAL=%xFilial:SA1%
           AND SA6.A6_FILIAL=%xFilial:SA6%
           AND SE1.E1_CLIENTE=SA1.A1_COD
           AND SE1.E1_LOJA=SA1.A1_LOJA
           AND SA6.A6_COD=%exp:cA6COD%
           AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
           AND SA6.A6_NUMCON=%exp:cA6NUMCON%
           AND SE1.E1_PORTADO=SA6.A6_COD
           AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
           AND SE1.E1_CONTA=SA6.A6_NUMCON
           AND SE1.E1_YSITAPI='2'
           AND SA6.A6_YTPINTB='1'
           AND SA1.A1_COD BETWEEN %exp:cA1CODDe% AND %exp:cA1CODAte%
           AND SE1.E1_VENCTO BETWEEN %exp:cE1VENCTODe% AND %exp:cE1VENCTOAte%
           AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
           AND SE1.E1_EMISSAO BETWEEN %exp:cE1EMISSAODe% AND %exp:cE1EMISSAOAte%
         ORDER BY SE1.E1_FILIAL
                ,SE1.E1_DATABOR
                ,SA1.A1_FILIAL
                ,SA1.A1_COD
                ,SE1.E1_PREFIXO
                ,SE1.E1_NUM
                ,SE1.E1_PARCELA
    endSQL

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRemessa","01","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    cAPITable:=StrTran(cAPITable,"%","")
    A35():tmpTableDrop(cAPITable)

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A1_COD","X3_TITULO","CODIGO")
    uToXML():setXMLVar("A1_NOME","X3_TITULO","RAZAO SOCIAL")
    uToXML():setXMLVar("E1_DATABOR","X3_TITULO","DATA REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","PREFIXO+NUMERO+PARCELA")
    uToXML():setXMLVar("E1_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E1_VENCTO","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("DIAS_ANTEC","X3_TITULO","DIAS ANTECIPADOS")
    uToXML():setXMLVar("E1_VENCREA","X3_TITULO","VENC.AJUSTADO")
    uToXML():setXMLVar("E1_VALOR","X3_TITULO","VALOR")
    uToXML():setXMLVar("E1_YFDCVAL","X3_TITULO","DESAGIO")
    uToXML():setXMLVar("E1_NUMBCO","X3_TITULO","NOSSO NUMERO")

    uToXML():setXMLVar("A1_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A1_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_DATABOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VENCTO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DIAS_ANTEC","X3_PICTURE","@R 9999")
    uToXML():setXMLVar("E1_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_YFDCVAL","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("E1_VALOR","TOTAL",.T.)
    uToXML():setXMLVar("E1_YFDCVAL","TOTAL",.T.)

    return(cTmpAlias)

static method getRecQueryRet(aParamRet,abcoIsFIDC,aFWTTables) class FIDC

    local aFields       as array

    local cA6COD        as character
    local cA6AGENCIA    as character
    local cA6NUMCON     as character

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cA1CODDe      as character
    local cA1CODAte     as character

    local cE1DATABORDe  as character
    local cE1DATABORAte as character

    local cE1EMISSAODe  as character
    local cE1EMISSAOAte as character

    local cE1VENCTODe   as character
    local cE1VENCTOAte  as character

    local cZK4DataDe    as character
    local cZK4DataAte   as character

    local cField        as character
    local cSQLFields    as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable        as object

    paramtype aParamRet as array
    paramtype abcoIsFIDC as array

    paramtype aFWTTables as array optional default array(0)

    cA6COD:=abcoIsFIDC[3]
    cA6AGENCIA:=abcoIsFIDC[4]
    cA6NUMCON:=abcoIsFIDC[5]

    cA1CODDe:=aParamRet[1]
    cA1CODAte:=aParamRet[2]

    cE1DATABORDe:=DToS(aParamRet[3])
    cE1DATABORAte:=DToS(aParamRet[4])

    cE1EMISSAODe:=DToS(aParamRet[5])
    cE1EMISSAOAte:=DToS(aParamRet[6])

    cE1VENCTODe:=DToS(aParamRet[7])
    cE1VENCTOAte:=DToS(aParamRet[8])

    cZK4DataDe:=DToS(aParamRet[9])
    cZK4DataAte:=DToS(aParamRet[10])

    cSQLFields:=""
    cSQLFields+="SA1.A1_COD"
    cSQLFields+=",SA1.A1_NOME"
    cSQLFields+=",SE1.E1_DATABOR"
    cSQLFields+=",(CASE SE1.E1_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E1_PREFIXO","X3_TAMANHO"))+"' ELSE SE1.E1_PREFIXO END)+SE1.E1_NUM+SE1.E1_PARCELA AS P_NUM_PARC"
    cSQLFields+=",SE1.E1_EMISSAO"
    cSQLFields+=",SE1.E1_VENCTO"
    cSQLFields+=",0  AS DIAS_ANTEC"
    cSQLFields+=",'' AS E1_VENCREA"
    cSQLFields+=",SE1.E1_VALOR"
    cSQLFields+=",SE1.E1_YFDCVAL"
    cSQLFields+=",LTRIM(RTRIM(ZK4.ZK4_NOSNUM)) AS ZK4_NOSNUM"

    if (stackTools():IsInCallStack("getRecQueryCon"))
        cSQLFields+=",SE1.R_E_C_N_O_ AS SE1RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E1_DATABOR  AS DATE
        COLUMN E1_EMISSAO  AS DATE
        COLUMN E1_VENCTO   AS DATE
        COLUMN E1_VENCREA  AS DATE
        COLUMN ZK4_DATA    AS DATE

        SELECT %exp:cSQLFields%
         FROM %table:SE1% SE1 (NOLOCK)
         JOIN %table:ZK4% ZK4 (NOLOCK)
           ON (
                    ZK4.%notDel%
                AND ZK4.ZK4_FILIAL=%xFilial:ZK4%
                AND SE1.E1_PORTADO=ZK4.ZK4_BANCO
                AND SE1.E1_AGEDEP=ZK4.ZK4_AGENCI
                AND SE1.E1_CONTA=ZK4.ZK4_CONTA
                AND SE1.E1_NUM+SE1.E1_PARCELA=ZK4.ZK4_NUMERO
                AND SE1.E1_NUMBCO=SUBSTRING(ZK4.ZK4_NOSNUM,1,11)
                AND SE1.E1_VENCTO<=ZK4.ZK4_DTVENC
                AND ZK4.ZK4_CODOCO='02'
                AND ZK4.ZK4_TIPO='R'
                AND ZK4.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
                AND ZK4.ZK4_EMP=%exp:cEmpAnt%
                AND ZK4.ZK4_FIL=%exp:cFilAnt%
                AND ZK4.ZK4_STATUS='2'
            )
         JOIN %table:SA1% SA1 (NOLOCK) ON (
                SA1.%notDel%
            AND SA1.A1_FILIAL=%xFilial:SA1%
            AND SE1.E1_CLIENTE=SA1.A1_COD
            AND SE1.E1_LOJA=SA1.A1_LOJA
         )
         JOIN %table:SA6% SA6 (NOLOCK) ON (
                SA6.%notDel%
            AND SA6.A6_FILIAL=%xFilial:SA6%
            AND SA6.A6_COD=%exp:cA6COD%
            AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
            AND SA6.A6_NUMCON=%exp:cA6NUMCON%
            AND SE1.E1_PORTADO=SA6.A6_COD
            AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
            AND SE1.E1_CONTA=SA6.A6_NUMCON
            AND SA6.A6_YTPINTB='1'
         )
        WHERE (1=2)
            AND SE1.%notDel%
            AND SA1.%notDel%
            AND SA6.%notDel%
            AND ZK4.%notDel%
            AND SE1.E1_FILIAL=%xFilial:SE1%
            AND SA1.A1_FILIAL=%xFilial:SA1%
            AND SA6.A6_FILIAL=%xFilial:SA6%
            AND SE1.E1_CLIENTE=SA1.A1_COD
            AND SE1.E1_LOJA=SA1.A1_LOJA
            AND SE1.E1_YSITAPI='2'
            AND SA6.A6_COD=%exp:cA6COD%
            AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
            AND SA6.A6_NUMCON=%exp:cA6NUMCON%
            AND SE1.E1_PORTADO=SA6.A6_COD
            AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
            AND SE1.E1_CONTA=SA6.A6_NUMCON
            AND SA6.A6_YTPINTB='1'
            AND SA1.A1_COD BETWEEN %exp:cA1CODDe% AND %exp:cA1CODAte%
            AND SE1.E1_VENCTO BETWEEN %exp:cE1VENCTODe% AND %exp:cE1VENCTOAte%
            AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
            AND SE1.E1_EMISSAO BETWEEN %exp:cE1EMISSAODe% AND %exp:cE1EMISSAOAte%
            AND ZK4.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
            AND ZK4.ZK4_CODOCO='02'
            AND ZK4.ZK4_TIPO='R'
            AND ZK4.ZK4_STATUS='2'
        ORDER BY SE1.E1_FILIAL
                ,SE1.E1_DATABOR
                ,SA1.A1_FILIAL
                ,SA1.A1_COD
                ,SE1.E1_PREFIXO
                ,SE1.E1_NUM
                ,SE1.E1_PARCELA

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRetorno","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A1_COD","X3_TITULO","CODIGO")
    uToXML():setXMLVar("A1_NOME","X3_TITULO","RAZAO SOCIAL")
    uToXML():setXMLVar("E1_DATABOR","X3_TITULO","DATA REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","PREFIXO+NUMERO+PARCELA")
    uToXML():setXMLVar("E1_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E1_VENCTO","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("DIAS_ANTEC","X3_TITULO","DIAS ANTECIPADOS")
    uToXML():setXMLVar("E1_VENCREA","X3_TITULO","VENC.AJUSTADO")
    uToXML():setXMLVar("E1_VALOR","X3_TITULO","VALOR")
    uToXML():setXMLVar("E1_YFDCVAL","X3_TITULO","DESAGIO")
    uToXML():setXMLVar("ZK4_NOSNUM","X3_TITULO","NOSSO NUMERO")

    uToXML():setXMLVar("A1_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A1_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_DATABOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VENCTO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DIAS_ANTEC","X3_PICTURE","@R 9999")
    uToXML():setXMLVar("E1_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_YFDCVAL","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("E1_VALOR","TOTAL",.T.)
    uToXML():setXMLVar("E1_YFDCVAL","TOTAL",.T.)

    return(cTmpAlias)

static method getRecQueryRec(aParamRet,abcoIsFIDC,aFWTTables) class FIDC

    local aFields       as array

    local cA6COD        as character
    local cA6AGENCIA    as character
    local cA6NUMCON     as character

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cA1CODDe      as character
    local cA1CODAte     as character

    local cE1DATABORDe  as character
    local cE1DATABORAte as character

    local cE1EMISSAODe  as character
    local cE1EMISSAOAte as character

    local cE1VENCTODe   as character
    local cE1VENCTOAte  as character

    local cZK4DataDe    as character
    local cZK4DataAte   as character

    local cField        as character
    local cSQLFields    as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as numeric

    paramtype aParamRet  as array
    paramtype abcoIsFIDC as array

    paramtype aFWTTables as array optional default array(0)

    cA6COD:=abcoIsFIDC[3]
    cA6AGENCIA:=abcoIsFIDC[4]
    cA6NUMCON:=abcoIsFIDC[5]

    cA1CODDe:=aParamRet[1]
    cA1CODAte:=aParamRet[2]

    cE1DATABORDe:=DToS(aParamRet[3])
    cE1DATABORAte:=DToS(aParamRet[4])

    cE1EMISSAODe:=DToS(aParamRet[5])
    cE1EMISSAOAte:=DToS(aParamRet[6])

    cE1VENCTODe:=DToS(aParamRet[7])
    cE1VENCTOAte:=DToS(aParamRet[8])

    cZK4DataDe:=DToS(aParamRet[9])
    cZK4DataAte:=DToS(aParamRet[10])

    cSQLFields:=""

    cSQLFields+=" SA1.A1_COD"
    cSQLFields+=",SA1.A1_NOME"
    cSQLFields+=",SE1.E1_DATABOR"
    cSQLFields+=",(CASE SE1.E1_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E1_PREFIXO","X3_TAMANHO"))+"' ELSE SE1.E1_PREFIXO END)+SE1.E1_NUM+SE1.E1_PARCELA AS P_NUM_PARC"
    cSQLFields+=",SE1.E1_EMISSAO"
    cSQLFields+=",SE1.E1_VENCTO"
    cSQLFields+=",0  AS DIAS_ANTEC"
    cSQLFields+=",'' AS E1_VENCREA"
    cSQLFields+=",SE1.E1_VALOR"
    cSQLFields+=",SE1.E1_YFDCVAL"
    cSQLFields+=",LTRIM(RTRIM(ZK4.ZK4_NOSNUM)) AS ZK4_NOSNUM"
    cSQLFields+=",ZK4.ZK4_VLREC"
    cSQLFields+=",ZK4.ZK4_VLJURO"
    cSQLFields+=",ZK4.ZK4_DTLIQ"
    cSQLFields+=",ZK4.ZK4_DTCRED"
    cSQLFields+=",SE1.E1_BAIXA"
    cSQLFields+=",ZK4.ZK4_VLDESC"

    if (stackTools():IsInCallStack("getRecQueryCon"))
        cSQLFields+=",SE1.R_E_C_N_O_ AS SE1RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E1_DATABOR  AS DATE
        COLUMN E1_EMISSAO  AS DATE
        COLUMN E1_VENCTO   AS DATE
        COLUMN E1_VENCREA  AS DATE
        COLUMN ZK4_DATA    AS DATE
        COLUMN ZK4_DTLIQ   AS DATE
        COLUMN ZK4_DTCRED  AS DATE
        COLUMN E1_BAIXA       AS DATE

        SELECT %exp:cSQLFields%
          FROM %table:SE1% SE1 (NOLOCK)
          JOIN %table:ZK4% ZK4 (NOLOCK)
            ON (
                    ZK4.%notDel%
                AND ZK4.ZK4_FILIAL=%xFilial:ZK4%
                AND SE1.E1_PORTADO=ZK4.ZK4_BANCO
                AND SE1.E1_AGEDEP=ZK4.ZK4_AGENCI
                AND SE1.E1_CONTA=ZK4.ZK4_CONTA
                AND SE1.E1_NUM+SE1.E1_PARCELA=ZK4.ZK4_NUMERO
                AND SE1.E1_NUMBCO=SUBSTRING(ZK4.ZK4_NOSNUM,1,11)
                AND SE1.E1_VENCTO<=ZK4.ZK4_DTVENC
                AND ZK4.ZK4_CODOCO='06'
                AND ZK4.ZK4_TIPO='R'
                AND ZK4.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
                AND ZK4.ZK4_EMP=%exp:cEmpAnt%
                AND ZK4.ZK4_FIL=%exp:cFilAnt%
                AND ZK4.ZK4_STATUS='2'
            )
         JOIN %table:SA1% SA1 (NOLOCK) ON (
                SA1.%notDel%
            AND SA1.A1_FILIAL=%xFilial:SA1%
            AND SE1.E1_CLIENTE=SA1.A1_COD
            AND SE1.E1_LOJA=SA1.A1_LOJA
         )
         JOIN %table:SA6% SA6 (NOLOCK) ON (
                SA6.%notDel%
            AND SA6.A6_FILIAL=%xFilial:SA6%
            AND SA6.A6_COD=%exp:cA6COD%
            AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
            AND SA6.A6_NUMCON=%exp:cA6NUMCON%
            AND SE1.E1_PORTADO=SA6.A6_COD
            AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
            AND SE1.E1_CONTA=SA6.A6_NUMCON
            AND SA6.A6_YTPINTB='1'
         )
        WHERE (1=2)
            AND SE1.%notDel%
            AND SA1.%notDel%
            AND SA6.%notDel%
            AND ZK4.%notDel%
            AND SE1.E1_FILIAL=%xFilial:SE1%
            AND SA1.A1_FILIAL=%xFilial:SA1%
            AND SA6.A6_FILIAL=%xFilial:SA6%
            AND SE1.E1_CLIENTE=SA1.A1_COD
            AND SE1.E1_LOJA=SA1.A1_LOJA
            AND SA6.A6_COD=%exp:cA6COD%
            AND SA6.A6_AGENCIA=%exp:cA6AGENCIA%
            AND SA6.A6_NUMCON=%exp:cA6NUMCON%
            AND SE1.E1_PORTADO=SA6.A6_COD
            AND SE1.E1_AGEDEP=SA6.A6_AGENCIA
            AND SE1.E1_CONTA=SA6.A6_NUMCON
            AND SE1.E1_YSITAPI='2'
            AND SA6.A6_YTPINTB='1'
            AND SA1.A1_COD BETWEEN %exp:cA1CODDe% AND %exp:cA1CODAte%
            AND SE1.E1_VENCTO BETWEEN %exp:cE1VENCTODe% AND %exp:cE1VENCTOAte%
            AND SE1.E1_DATABOR BETWEEN %exp:cE1DATABORDe% AND %exp:cE1DATABORAte%
            AND SE1.E1_EMISSAO BETWEEN %exp:cE1EMISSAODe% AND %exp:cE1EMISSAOAte%
            AND ZK4.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
            AND ZK4.ZK4_CODOCO='06'
            AND ZK4.ZK4_TIPO='R'
            AND ZK4.ZK4_STATUS='2'
        ORDER BY SE1.E1_FILIAL
                ,SE1.E1_DATABOR
                ,SA1.A1_FILIAL
                ,SA1.A1_COD
                ,SE1.E1_PREFIXO
                ,SE1.E1_NUM
                ,SE1.E1_PARCELA

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRecebidos","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A1_COD","X3_TITULO","CODIGO")
    uToXML():setXMLVar("A1_NOME","X3_TITULO","RAZAO SOCIAL")
    uToXML():setXMLVar("E1_DATABOR","X3_TITULO","DATA REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","PREFIXO+NUMERO+PARCELA")
    uToXML():setXMLVar("E1_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E1_VENCTO","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("DIAS_ANTEC","X3_TITULO","DIAS ANTECIPADOS")
    uToXML():setXMLVar("E1_VENCREA","X3_TITULO","VENC.AJUSTADO")
    uToXML():setXMLVar("E1_VALOR","X3_TITULO","VALOR ORIGINAL")
    uToXML():setXMLVar("E1_YFDCVAL","X3_TITULO","DESAGIO")
    uToXML():setXMLVar("ZK4_NOSNUM","X3_TITULO","NOSSO NUMERO")
    uToXML():setXMLVar("ZK4_VLREC","X3_TITULO","VALOR RECEBIDO")
    uToXML():setXMLVar("ZK4_VLJURO","X3_TITULO","VALOR JUROS")
    uToXML():setXMLVar("ZK4_DTLIQ","X3_TITULO","DATA LIQUIDACAO")
    uToXML():setXMLVar("ZK4_DTCRED","X3_TITULO","DATA CREDITO")
    uToXML():setXMLVar("E1_BAIXA","X3_TITULO","DATA BAIXA")
    uToXML():setXMLVar("ZK4_VLDESC","X3_TITULO","VALOR DESCONTO")

    uToXML():setXMLVar("A1_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A1_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_DATABOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VENCTO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DIAS_ANTEC","X3_PICTURE","@R 9999")
    uToXML():setXMLVar("E1_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_YFDCVAL","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_VLREC","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_VLJURO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_DTLIQ","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_DTCRED","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_BAIXA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_VLDESC","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("E1_VALOR","TOTAL",.T.)
    uToXML():setXMLVar("E1_YFDCVAL","TOTAL",.T.)
    uToXML():setXMLVar("ZK4_VLREC","TOTAL",.T.)
    uToXML():setXMLVar("ZK4_VLJURO","TOTAL",.T.)
    uToXML():setXMLVar("ZK4_VLDESC","TOTAL",.T.)

    return(cTmpAlias)

static method getRecQueryCon(aParamRet,abcoIsFIDC,aFWTTables) class FIDC

    local aFields       as array

    local cA6COD        as character
    local cA6AGENCIA    as character
    local cA6NUMCON     as character

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cA1CODDe      as character
    local cA1CODAte     as character

    local cE1DATABORDe  as character
    local cE1DATABORAte as character

    local cE1EMISSAODe  as character
    local cE1EMISSAOAte as character

    local cE1VENCTODe   as character
    local cE1VENCTOAte  as character

    local cZK4DataDe    as character
    local cZK4DataAte   as character

    local cField        as character

    local cTableRem     as character
    local cTableRet     as character
    local cTableRec     as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as object

    paramtype aParamRet as array
    paramtype abcoIsFIDC as array

    paramtype aFWTTables as array optional DEFAULT array(0)

    cA6COD:=abcoIsFIDC[3]
    cA6AGENCIA:=abcoIsFIDC[4]
    cA6NUMCON:=abcoIsFIDC[5]

    cA1CODDe:=aParamRet[1]
    cA1CODAte:=aParamRet[2]

    cE1DATABORDe:=DToS(aParamRet[3])
    cE1DATABORAte:=DToS(aParamRet[4])

    cE1EMISSAODe:=DToS(aParamRet[5])
    cE1EMISSAOAte:=DToS(aParamRet[6])

    cE1VENCTODe:=DToS(aParamRet[7])
    cE1VENCTOAte:=DToS(aParamRet[8])

    cZK4DataDe:=DToS(aParamRet[9])
    cZK4DataAte:=DToS(aParamRet[10])

    cTmpAlias:=FIDC():getRecQueryRem(@aParamRet,@abcoIsFIDC,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableRem:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableRem:="%"+cTableRem+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=FIDC():getRecQueryRet(@aParamRet,@abcoIsFIDC,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableRet:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableRet:="%"+cTableRet+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=FIDC():getRecQueryRec(@aParamRet,@abcoIsFIDC,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableRec:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableRec:="%"+cTableRec+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E1_DATABOR  AS DATE
        COLUMN E1_EMISSAO  AS DATE
        COLUMN E1_VENCTO   AS DATE
        COLUMN E1_BAIXA    AS DATE

        SELECT REM.A1_COD
              ,REM.A1_NOME
              ,REM.E1_DATABOR
              ,REM.P_NUM_PARC
              ,REM.E1_EMISSAO
              ,REM.E1_VENCTO
              ,ISNULL(REC.E1_BAIXA,'')  AS E1_BAIXA
              ,ISNULL(REM.E1_VALOR,0)   AS ENVIADO
              ,ISNULL(RET.E1_VALOR,0)   AS REGISTRADO
              ,ISNULL(REC.ZK4_VLREC,0)  AS BAIXADO
              ,ISNULL(REC.ZK4_VLJURO,0) AS ZK4_VLJURO
              ,ISNULL(REC.ZK4_VLDESC,0) AS ZK4_VLDESC
              ,(CASE WHEN ISNULL(REC.ZK4_VLJURO,0)>0 THEN (ISNULL(REM.E1_VALOR,0)/ISNULL(REM.E1_VALOR,0)) ELSE 0 END) AS JUROS
              ,(CASE WHEN ISNULL(REM.E1_VALOR,0)=ISNULL(RET.E1_VALOR,0)    THEN 'CONCILIADO' ELSE 'PENDENTE' END) AS REGISTRO
              ,(CASE WHEN ISNULL(REC.ZK4_VLREC,0)>=ISNULL(REM.E1_VALOR,0)  THEN 'CONCILIADO' ELSE 'PENDENTE' END) AS BAIXA
              ,(CASE WHEN ((ISNULL(REC.E1_BAIXA,'')<>'') AND (ISNULL(REC.E1_BAIXA,'')<ISNULL(REM.E1_VENCTO,''))) THEN 'ANTECIPADO' ELSE (CASE WHEN ISNULL(REC.E1_BAIXA,'')=ISNULL(REM.E1_VENCTO,'') THEN 'CONCILIADO' ELSE 'VENCIDO' END) END) AS DTBAIXA
        FROM %exp:cTableRem% REM (NOLOCK)
        FULL OUTER JOIN %exp:cTableRet% RET (NOLOCK)
            ON (
                    REM.SE1RECNO=RET.SE1RECNO
         )
        FULL OUTER JOIN %exp:cTableRec% REC (NOLOCK) ON (
                REM.SE1RECNO=REC.SE1RECNO
         )
        WHERE (1=2)
        ORDER BY REM.E1_DATABOR
                ,REM.A1_COD
                ,REM.P_NUM_PARC

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRecebidos","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A1_COD","X3_TITULO","CODIGO")
    uToXML():setXMLVar("A1_NOME","X3_TITULO","RAZAO SOCIAL")
    uToXML():setXMLVar("E1_DATABOR","X3_TITULO","DATA REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","PREFIXO+NUMERO+PARCELA")
    uToXML():setXMLVar("E1_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E1_VENCTO","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("ENVIADO","X3_TITULO","ENVIADO")
    uToXML():setXMLVar("REGISTRADO","X3_TITULO","REGISTRADO")
    uToXML():setXMLVar("BAIXADO","X3_TITULO","BAIXADO")
    uToXML():setXMLVar("DTBAIXA","X3_TITULO","DT. BAIXA")
    uToXML():setXMLVar("ZK4_VLDESC","X3_TITULO","VALOR DESCONTO")

    uToXML():setXMLVar("A1_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A1_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E1_DATABOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E1_VENCTO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ENVIADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("REGISTRADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("BAIXADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DTBAIXA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_VLJURO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("JUROS","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ZK4_VLDESC","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("ENVIADO","TOTAL",.T.)
    uToXML():setXMLVar("REGISTRADO","TOTAL",.T.)
    uToXML():setXMLVar("BAIXADO","TOTAL",.T.)
    uToXML():setXMLVar("ZK4_VLJURO","TOTAL",.T.)
    uToXML():setXMLVar("ZK4_VLDESC","TOTAL",.T.)

    return(cTmpAlias)

 static method getPagQueryRem(aParamRet,aFWTTables) class FIDC

    local aFields           as array

    local cTmpAlias         as character
    local cTmpTable         as character
 
    local cA2CODDe          as character
    local cA2CODAte         as character

    local cE2DATABORDe      as character
    local cE2DATABORAte     as character

    local cE2EMISSAODe      as character
    local cE2EMISSAOAte     as character

    local cE2VENCTODe       as character
    local cE2VENCTOAte      as character

    local cSQLPath          as character
    local cSQLFile          as character
    local cSQLQuery         as character
    local cSQLInsert        as character

    local cTXSelic          as character

    local cField            as character
    local cSQLFields        as character

    local nField            as numeric
    local nFields           as numeric

    local oFWTTable         as object

    paramtype aParamRet as array
    paramtype aFWTTables as array optional default array(0)

    cA2CODDe:=aParamRet[1]
    cA2CODAte:=aParamRet[2]

    cE2DATABORDe:=DToS(aParamRet[3])
    cE2DATABORAte:=DToS(aParamRet[4])

    cE2EMISSAODe:=DToS(aParamRet[5])
    cE2EMISSAOAte:=DToS(aParamRet[6])

    cE2VENCTODe:=DToS(aParamRet[7])
    cE2VENCTOAte:=DToS(aParamRet[8])
  
    if (stackTools():IsInCallStack("getPagQueryCon"))
        cTXSelic:=cValToChar(0)
    else
        cTXSelic:=cValToChar(aParamRet[9])
    endif

    cTmpAlias:=getNextAlias()

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"
    
    cSQLFields:=""
    cSQLFields+="   SA2.A2_COD"
	cSQLFields+="  ,SA2.A2_NOME"
    cSQLFields+="  ,SE2.E2_DTBORDE"
	cSQLFields+="  ,(CASE SE2.E2_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E2_PREFIXO","X3_TAMANHO"))+"' ELSE SE2.E2_PREFIXO END)+SE2.E2_NUM+SE2.E2_PARCELA AS P_NUM_PARC"
	cSQLFields+="  ,SE2.E2_EMISSAO"
	cSQLFields+="  ,SE2.E2_VENCORI"
	cSQLFields+="  ,DATEDIFF(DAY,CAST(SE2.E2_VENCREA AS DATE),CAST(SE2.E2_VENCORI AS DATE)) DIAS_ANTEC"
	cSQLFields+="  ,SE2.E2_VENCREA"
	cSQLFields+="  ,SE2.E2_VALOR"
	cSQLFields+="  ,SE2.E2_YANTDES"
	cSQLFields+="  ,(SE2.E2_VALOR-SE2.E2_YANTDES) AS VLR_ANTEC"
	cSQLFields+="  ,0 AS 'TAR_TED'"
	cSQLFields+="  ,SE2.E2_VALLIQ"
	cSQLFields+="  ,SE2.E2_YANTTX"
	cSQLFields+="  ,"+cTXSelic+" AS TXSELIC"

    if (stackTools():IsInCallStack("getPagQueryCon"))
        cSQLFields+=",SE2.R_E_C_N_O_ AS SE2RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    beginSQL alias cTmpAlias

        %noparser%

        SELECT %exp:cSQLFields%
          FROM %table:SE2% SE2 (NOLOCK)
		  JOIN %table:SA2% SA2 (NOLOCK) ON (
                SA2.A2_COD=SE2.E2_FORNECE 
            AND SA2.A2_LOJA=SE2.E2_LOJA
          )
         WHERE (1=2)
           AND SE2.%notDel%
           AND SA2.%notDel%
           AND SA2.A2_COD BETWEEN %exp:cA2CODDe% AND %exp:cA2CODAte%
           AND SE2.E2_DTBORDE BETWEEN %exp:cE2DATABORDe% AND %exp:cE2DATABORAte%
           AND SE2.E2_EMISSAO BETWEEN %exp:cE2EMISSAODe% AND %exp:cE2EMISSAOAte%
           AND E2_VENCREA BETWEEN %exp:cE2VENCTODe% AND %exp:cE2VENCTOAte%
           AND SE2.E2_YANTTX>0 
           AND SE2.E2_YANTDES>0
           AND SE2.E2_YSITAPI='2' 
      ORDER BY SE2.E2_FILIAL
              ,SE2.E2_DTBORDE
              ,SA2.A2_FILIAL
              ,SA2.A2_COD
              ,SE2.E2_PREFIXO
              ,SE2.E2_NUM
              ,SE2.E2_PARCELA

    endSQL

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCPagarRelatorioRemessa","01","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A2_COD","X3_TITULO","CÓDIGO")
    uToXML():setXMLVar("A2_NOME","X3_TITULO","FORNECEDOR")
    uToXML():setXMLVar("E2_DTBORDE","X3_TITULO","REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","TITULO")
    uToXML():setXMLVar("E2_EMISSAO","X3_TITULO","EMISSÃO")
    uToXML():setXMLVar("E2_VENCORI","X3_TITULO","VCTO REAL")
    uToXML():setXMLVar("DIAS_ANTEC","X3_TITULO","DIAS ANTECIPADOS")
    uToXML():setXMLVar("E2_VENCREA","X3_TITULO","NOVO VCTO")
    uToXML():setXMLVar("E2_VALOR","X3_TITULO","VALOR REAL")
    uToXML():setXMLVar("E2_YANTDES","X3_TITULO","DESÁGIO/DESCONTO")
    uToXML():setXMLVar("VLR_ANTEC","X3_TITULO","VALOR ANTECIPADO")
    uToXML():setXMLVar("TAR_TED","X3_TITULO","TARIFA TED")
    uToXML():setXMLVar("E2_VALLIQ","X3_TITULO","VALOR LIQUIDO")
    uToXML():setXMLVar("E2_YANTTX","X3_TITULO","TAXA (%)")
    uToXML():setXMLVar("TXSELIC","X3_TITULO","(%) SELIC")

    uToXML():setXMLVar("A2_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A2_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_DTBORDE","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VENCORI","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DIAS_ANTEC","X3_PICTURE","@R 9999")
    uToXML():setXMLVar("E2_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_YANTDES","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("VLR_ANTEC","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("TAR_TED","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALLIQ","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_YANTTX","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("TXSELIC","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("E2_VALOR","TOTAL",.T.)
    uToXML():setXMLVar("E2_YANTDES","TOTAL",.T.)
    uToXML():setXMLVar("VLR_ANTEC","TOTAL",.T.)
    uToXML():setXMLVar("E2_VALLIQ","TOTAL",.T.)    

    return(cTmpAlias)

static method getPagQueryRet(aParamRet,aFWTTables) class FIDC

    local aFields       as array

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cE2DATABORDe  as character
    local cE2DATABORAte as character

    local cE2EMISSAODe  as character
    local cE2EMISSAOAte as character

    local cE2VENCTODe   as character
    local cE2VENCTOAte  as character

    local cZK4DataDe    as character
    local cZK4DataAte   as character

    local cField        as character
    local cSQLFields    as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as object

    paramtype aParamRet as array
    paramtype aFWTTables as array optional default array(0)

    cA2CODDe:=aParamRet[1]
    cA2CODAte:=aParamRet[2]

    cE2DATABORDe:=DToS(aParamRet[3])
    cE2DATABORAte:=DToS(aParamRet[4])

    cE2EMISSAODe:=DToS(aParamRet[5])
    cE2EMISSAOAte:=DToS(aParamRet[6])

    cE2VENCTODe:=DToS(aParamRet[7])
    cE2VENCTOAte:=DToS(aParamRet[8])

    cZK4DataDe:=DToS(aParamRet[9])
    cZK4DataAte:=DToS(aParamRet[10])

    cSQLFields:=""
    cSQLFields+=" SA2.A2_COD"
	cSQLFields+=",SA2.A2_NOME"
    cSQLFields+=",SE2.E2_DTBORDE"
	cSQLFields+=",(CASE SE2.E2_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E2_PREFIXO","X3_TAMANHO"))+"' ELSE SE2.E2_PREFIXO END)+SE2.E2_NUM+SE2.E2_PARCELA AS P_NUM_PARC"
	cSQLFields+=",SE2.E2_EMISSAO"
	cSQLFields+=",SE2.E2_VENCREA"
	cSQLFields+=",SE2.E2_VALOR"
	cSQLFields+=",SE2.E2_YANTDES"
	cSQLFields+=",SE2.E2_VALLIQ"
	cSQLFields+=",(CASE FI8.FI8_PRFDES WHEN '' THEN '"+Replicate("-",GetSX3Cache("FI8_PRFDES","X3_TAMANHO"))+"' ELSE FI8.FI8_PRFDES END)+FI8.FI8_NUMDES+FI8.FI8_PARDES  AS TITFORFIDC"

    if (stackTools():IsInCallStack("getPagQueryCon"))
        cSQLFields+=",SE2.R_E_C_N_O_ AS SE2RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E2_DTBORDE  AS DATE
        COLUMN E2_EMISSAO  AS DATE
        COLUMN E2_VENCREA  AS DATE
        COLUMN ZK4_DATA    AS DATE

        SELECT %exp:cSQLFields%
          FROM %table:SE2% SE2 (NOLOCK)
          JOIN %table:SA2% SA2 (NOLOCK) ON (
                SA2.A2_COD=SE2.E2_FORNECE 
            AND SA2.A2_LOJA=SE2.E2_LOJA
          )
          JOIN %table:ZK4% ZK4 (NOLOCK) ON (
						ZK4.ZK4_TIPO='F' 
					AND SE2.R_E_C_N_O_=CAST(ZK4.ZK4_IDCNAB AS FLOAT)
          )
          JOIN %table:FI8% FI8 (NOLOCK) ON (
								FI8.FI8_FILIAL=SE2.E2_FILIAL 
							AND FI8.FI8_PRFORI=SE2.E2_PREFIXO 
							AND FI8.FI8_NUMORI=SE2.E2_NUM 
							AND FI8.FI8_PARORI=SE2.E2_PARCELA 
							AND FI8.FI8_TIPORI=SE2.E2_TIPO 
							AND FI8.FI8_FORORI=SE2.E2_FORNECE 
							AND FI8.FI8_LOJORI=SE2.E2_LOJA
          )
        WHERE (1=2)
          AND SE2.%notDel%
          AND SA2.%notDel%
          AND ZK4.%notDel%
          AND FI8.%notDel%
          AND SA2.A2_COD BETWEEN %exp:cA2CODDe% AND %exp:cA2CODAte%
          AND SE2.E2_DTBORDE BETWEEN %exp:cE2DATABORDe% AND %exp:cE2DATABORAte%
          AND SE2.E2_EMISSAO BETWEEN %exp:cE2EMISSAODe% AND %exp:cE2EMISSAOAte%
          AND SE2.E2_VENCREA BETWEEN %exp:cE2VENCTODe% AND %exp:cE2VENCTOAte%
          AND ZK4.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
          AND SE2.E2_YANTTX>0 
          AND SE2.E2_YANTDES>0
          AND ZK4.ZK4_TIPO='F'
          AND ZK4.ZK4_STATUS='2'
          AND SE2.E2_YSITAPI='2'
     ORDER BY SE2.E2_FILIAL
             ,SE2.E2_DTBORDE
             ,SA2.A2_FILIAL
             ,SA2.A2_COD
             ,SE2.E2_PREFIXO
             ,SE2.E2_NUM
             ,SE2.E2_PARCELA
    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRetorno","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A2_COD","X3_TITULO","CÓDIGO")
    uToXML():setXMLVar("A2_NOME","X3_TITULO","FORNECEDOR")
    uToXML():setXMLVar("E2_DTBORDE","X3_TITULO","REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","PREFIXO+NUMERO+PARCELA")
    uToXML():setXMLVar("E2_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E2_VENCREA","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("E2_VALOR","X3_TITULO","VALOR")
    uToXML():setXMLVar("E2_YANTDES","DESAGIO")
    uToXML():setXMLVar("E2_VALLIQ","X3_TITULO","VALOR LIQUIDO")
    uToXML():setXMLVar("TITFORFIDC","X3_TITULO","TÍTULO FORNECEDOR FIDC")

    uToXML():setXMLVar("A2_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A2_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_DTBORDE","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_YANTDES","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALLIQ","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("TITFORFIDC","X3_PICTURE","@!")

    uToXML():setXMLVar("E2_VALOR","TOTAL",.T.)
    uToXML():setXMLVar("E2_YANTDES","TOTAL",.T.)
    uToXML():setXMLVar("E2_VALLIQ","TOTAL",.T.)

    return(cTmpAlias)

static method getPagQueryTit(aParamRet,aFWTTables) class FIDC

    local aFields       as array

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cE2DATABORDe  as character
    local cE2DATABORAte as character

    local cE2EMISSAODe  as character
    local cE2EMISSAOAte as character

    local cE2VENCTODe   as character
    local cE2VENCTOAte  as character

    local cZK4DataDe    as character
    local cZK4DataAte   as character

    local cField        as character
    local cSQLFields    as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as object

    paramtype aParamRet as array
    paramtype aFWTTables as array optional default array(0)

    cA2CODDe:=aParamRet[1]
    cA2CODAte:=aParamRet[2]

    cE2DATABORDe:=DToS(aParamRet[3])
    cE2DATABORAte:=DToS(aParamRet[4])

    cE2EMISSAODe:=DToS(aParamRet[5])
    cE2EMISSAOAte:=DToS(aParamRet[6])

    cE2VENCTODe:=DToS(aParamRet[7])
    cE2VENCTOAte:=DToS(aParamRet[8])

    cZK4DataDe:=DToS(aParamRet[9])
    cZK4DataAte:=DToS(aParamRet[10])

    cSQLFields:=""
    cSQLFields+=" SA2.A2_COD"
    cSQLFields+=",SA2.A2_NOME"
    cSQLFields+=",SE2.E2_DTBORDE"
    cSQLFields+=",(CASE SE2.E2_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E2_PREFIXO","X3_TAMANHO"))+"' ELSE SE2.E2_PREFIXO END)+SE2.E2_NUM+SE2.E2_PARCELA AS P_NUM_PARC"
    cSQLFields+=",SE2.E2_EMISSAO
    cSQLFields+=",SE2.E2_VENCREA
    cSQLFields+=",SE2.E2_VALOR
    cSQLFields+=",x.ZK4_NOSNUM
    cSQLFields+=",x.E2_FORNECE
    cSQLFields+=",x.E2_NOMFOR
    cSQLFields+=",(CASE FI8.FI8_PRFORI WHEN '' THEN '"+Replicate("-",GetSX3Cache("FI8_PRFORI","X3_TAMANHO"))+"' ELSE FI8.FI8_PRFORI END)+FI8.FI8_NUMORI+FI8.FI8_PARORI  AS TITFORORIG"

    if (stackTools():IsInCallStack("getPagQueryCon"))
        cSQLFields+=",x.SE2RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E2_DTBORDE  AS DATE
        COLUMN E2_EMISSAO  AS DATE
        COLUMN E2_VENCREA  AS DATE
        COLUMN ZK4_DATA    AS DATE

        SELECT %exp:cSQLFields%
          FROM %table:SE2% SE2 (NOLOCK)
          JOIN %table:SA2% SA2 (NOLOCK) ON (
                SA2.A2_COD=SE2.E2_FORNECE 
            AND SA2.A2_LOJA=SE2.E2_LOJA
          )
          JOIN %table:FI8% FI8 (NOLOCK) ON (
                FI8.FI8_FILDES=SE2.E2_FILIAL 
            AND FI8.FI8_PRFDES=SE2.E2_PREFIXO 
            AND FI8.FI8_NUMDES=SE2.E2_NUM 
            AND FI8.FI8_PARDES=SE2.E2_PARCELA 
            AND FI8.FI8_TIPDES=SE2.E2_TIPO 
            AND FI8.FI8_FORDES=SE2.E2_FORNECE 
            AND FI8.FI8_LOJDES=SE2.E2_LOJA
          )
          JOIN (
                SELECT FI8_O.R_E_C_N_O_ FI8RECNO 
                      ,SE2_O.E2_FORNECE
                      ,SE2_O.E2_NOMFOR
                      ,ZK4_O.ZK4_NOSNUM
                      ,SE2_O.R_E_C_N_O_ SE2RECNO
                  FROM %table:SE2% SE2_O (NOLOCK)
                  JOIN %table:ZK4% ZK4_O (NOLOCK) ON (
                        ZK4_O.ZK4_TIPO='F' 
                    AND SE2_O.R_E_C_N_O_=CAST(ZK4_O.ZK4_IDCNAB AS FLOAT)
                  )
                  JOIN %table:FI8% FI8_O (NOLOCK) ON (
                            FI8_O.FI8_FILIAL=SE2_O.E2_FILIAL 
                        AND FI8_O.FI8_PRFORI=SE2_O.E2_PREFIXO 
                        AND FI8_O.FI8_NUMORI=SE2_O.E2_NUM 
                        AND FI8_O.FI8_PARORI=SE2_O.E2_PARCELA 
                        AND FI8_O.FI8_TIPORI=SE2_O.E2_TIPO 
                        AND FI8_O.FI8_FORORI=SE2_O.E2_FORNECE 
                        AND FI8_O.FI8_LOJORI=SE2_O.E2_LOJA
                   )
                 WHERE SE2_O.%notDel%
                   AND ZK4_O.%notDel%
                   AND SE2_O.E2_YANTTX>0 
                   AND SE2_O.E2_YANTDES>0
                   AND SE2_O.E2_YSITAPI='2'
                   AND ZK4_O.ZK4_TIPO='F'
                   AND ZK4_O.ZK4_STATUS='2'
                   AND ZK4_O.ZK4_DATA BETWEEN %exp:cZK4DataDe% AND %exp:cZK4DataAte%
                   AND FI8_O.FI8_FILIAL=SE2_O.E2_FILIAL 
                   AND FI8_O.FI8_PRFORI=SE2_O.E2_PREFIXO 
                   AND FI8_O.FI8_NUMORI=SE2_O.E2_NUM 
                   AND FI8_O.FI8_PARORI=SE2_O.E2_PARCELA 
                   AND FI8_O.FI8_TIPORI=SE2_O.E2_TIPO 
                   AND FI8_O.FI8_FORORI=SE2_O.E2_FORNECE 
                   AND FI8_O.FI8_LOJORI=SE2_O.E2_LOJA		
                ) x ON (x.FI8RECNO=FI8.R_E_C_N_O_)	
        WHERE (1=2)
          AND SE2.D_E_L_E_T_=''
          AND SA2.D_E_L_E_T_=''
          AND FI8.D_E_L_E_T_=' '
          AND SA2.A2_COD BETWEEN %exp:cA2CODDe% AND %exp:cA2CODAte%
          AND SE2.E2_DTBORDE BETWEEN %exp:cE2DATABORDe% AND %exp:cE2DATABORAte%
          AND SE2.E2_EMISSAO BETWEEN %exp:cE2EMISSAODe% AND %exp:cE2EMISSAOAte%
          AND SE2.E2_VENCREA BETWEEN %exp:cE2VENCTODe% AND %exp:cE2VENCTOAte%
     ORDER BY SE2.E2_FILIAL
             ,SE2.E2_DTBORDE
             ,SA2.A2_FILIAL
             ,SA2.A2_COD
             ,SE2.E2_PREFIXO
             ,SE2.E2_NUM
             ,SE2.E2_PARCELA

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCPagarRelatorioTituloFornecedor","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A2_COD","X3_TITULO","CÓDIGO")
    uToXML():setXMLVar("A2_NOME","X3_TITULO","FORNECEDOR")
    uToXML():setXMLVar("E2_DTBORDE","X3_TITULO","REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","TÍTULO")
    uToXML():setXMLVar("E2_EMISSAO","X3_TITULO","EMISSÃO")
    uToXML():setXMLVar("E2_VENCREA","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("E2_VALOR","X3_TITULO","VALOR ORIGINAL")
    uToXML():setXMLVar("ZK4_NOSNUM","X3_TITULO","NOSSO NÚMERO")
    uToXML():setXMLVar("E2_FORNECE","X3_TITULO","CÓDIGO FORNECEDOR")
    uToXML():setXMLVar("E2_NOMFOR","X3_TITULO","NOME FORNECEDOR")
    uToXML():setXMLVar("TITFORORIG","X3_TITULO","TÍTULO ORIGINAL FORNECEDOR")

    uToXML():setXMLVar("A2_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A2_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_DTBORDE","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALOR","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("TITFORORIG","X3_PICTURE","@!")

    uToXML():setXMLVar("E2_VALOR","TOTAL",.T.)

    return(cTmpAlias)

static method getPagQueryLiq(aParamRet,aFWTTables) class FIDC

    local aFields       as array

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cA2CODDe      as character
    local cA2CODAte     as character

    local cE2DATABORDe  as character
    local cE2DATABORAte as character

    local cE2EMISSAODe  as character
    local cE2EMISSAOAte as character

    local cE2VENCTODe   as character
    local cE2VENCTOAte  as character

    local cE2BaixaDe    as character
    local cE2BaixaAte   as character

    local cField        as character
    local cSQLFields    as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as numeric

    paramtype aParamRet  as array
    paramtype aFWTTables as array optional default array(0)

    cA2CODDe:=aParamRet[1]
    cA2CODAte:=aParamRet[2]

    cE2DATABORDe:=DToS(aParamRet[3])
    cE2DATABORAte:=DToS(aParamRet[4])

    cE2EMISSAODe:=DToS(aParamRet[5])
    cE2EMISSAOAte:=DToS(aParamRet[6])

    cE2VENCTODe:=DToS(aParamRet[7])
    cE2VENCTOAte:=DToS(aParamRet[8])

    cE2BaixaDe:=DToS(aParamRet[9])
    cE2BaixaAte:=DToS(aParamRet[10])

    cSQLFields:=""

    cSQLFields+=" SA2.A2_COD"
	cSQLFields+=",SA2.A2_NOME"
    cSQLFields+=",(CASE SE2.E2_PREFIXO WHEN '' THEN '"+Replicate("-",GetSX3Cache("E2_PREFIXO","X3_TAMANHO"))+"' ELSE SE2.E2_PREFIXO END)+SE2.E2_NUM+SE2.E2_PARCELA AS P_NUM_PARC"
	cSQLFields+=",SE2.E2_EMISSAO"
	cSQLFields+=",SE2.E2_VENCREA"
	cSQLFields+=",SE2.E2_VALLIQ"
	cSQLFields+=",SE2.E2_BAIXA"
	cSQLFields+=",x.ZK4_NOSNUM"
	cSQLFields+=",x.E2_FORNECE"
	cSQLFields+=",x.E2_NOMFOR"
	cSQLFields+=",(CASE FI8.FI8_PRFORI WHEN '' THEN '"+Replicate("-",GetSX3Cache("FI8_PRFORI","X3_TAMANHO"))+"' ELSE FI8.FI8_PRFORI END)+FI8.FI8_NUMORI+FI8.FI8_PARORI  AS TITFORORIG"

    if (stackTools():IsInCallStack("getPagQueryCon"))
        cSQLFields+=",x.SE2RECNO"
    endif

    cSQLFields:="%"+cSQLFields+"%"

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E2_EMISSAO  AS DATE
        COLUMN E2_VENCREA  AS DATE
        COLUMN E2_BAIXA    AS DATE

        SELECT %exp:cSQLFields%
          FROM %table:SE2% SE2 (NOLOCK)
          JOIN %table:SA2% SA2 (NOLOCK) ON (
                SA2.A2_COD=SE2.E2_FORNECE 
            AND SA2.A2_LOJA=SE2.E2_LOJA
          )
          JOIN %table:FI8% FI8 (NOLOCK) ON (
                    FI8.FI8_FILDES=SE2.E2_FILIAL 
                AND FI8.FI8_PRFDES=SE2.E2_PREFIXO 
                AND FI8.FI8_NUMDES=SE2.E2_NUM 
                AND FI8.FI8_PARDES=SE2.E2_PARCELA 
                AND FI8.FI8_TIPDES=SE2.E2_TIPO 
                AND FI8.FI8_FORDES=SE2.E2_FORNECE 
                AND FI8.FI8_LOJDES=SE2.E2_LOJA
          )
          JOIN (   
                SELECT FI8_O.R_E_C_N_O_ AS FI8RECNO 
                      ,SE2_O.E2_FORNECE
                      ,SE2_O.E2_NOMFOR
                      ,ZK4_O.ZK4_NOSNUM
                      ,SE2_O.R_E_C_N_O_ AS SE2RECNO
                  FROM %table:SE2% SE2_O (NOLOCK)
                  JOIN %table:ZK4% ZK4_O (NOLOCK) ON (
                            ZK4_O.ZK4_TIPO='F' 
                        AND SE2_O.R_E_C_N_O_=CAST(ZK4_O.ZK4_IDCNAB AS FLOAT)
                  )
                  JOIN %table:FI8% FI8_O (NOLOCK) ON (
                            FI8_O.FI8_FILIAL=SE2_O.E2_FILIAL 
                        AND FI8_O.FI8_PRFORI=SE2_O.E2_PREFIXO 
                        AND FI8_O.FI8_NUMORI=SE2_O.E2_NUM 
                        AND FI8_O.FI8_PARORI=SE2_O.E2_PARCELA 
                        AND FI8_O.FI8_TIPORI=SE2_O.E2_TIPO 
                        AND FI8_O.FI8_FORORI=SE2_O.E2_FORNECE 
                        AND FI8_O.FI8_LOJORI=SE2_O.E2_LOJA
                    )
                 WHERE SE2_O.D_E_L_E_T_=''
                   AND ZK4_O.D_E_L_E_T_=''
                   AND SE2_O.E2_YANTTX>0 
                   AND SE2_O.E2_YANTDES>0
                   AND SE2_O.E2_YSITAPI='2'
                   AND ZK4_O.ZK4_TIPO='F'
                   AND ZK4_O.ZK4_STATUS='2'
                   AND FI8_O.FI8_FILIAL=SE2_O.E2_FILIAL 
                   AND FI8_O.FI8_PRFORI=SE2_O.E2_PREFIXO 
                   AND FI8_O.FI8_NUMORI=SE2_O.E2_NUM 
                   AND FI8_O.FI8_PARORI=SE2_O.E2_PARCELA 
                   AND FI8_O.FI8_TIPORI=SE2_O.E2_TIPO 
                   AND FI8_O.FI8_FORORI=SE2_O.E2_FORNECE 
                   AND FI8_O.FI8_LOJORI=SE2_O.E2_LOJA	
                ) x ON (x.FI8RECNO=FI8.R_E_C_N_O_)	
        WHERE (1=2)
          AND SE2.%notDel%
          AND SA2.%notDel%
          AND FI8.%notDel%
          AND SA2.A2_COD BETWEEN %exp:cA2CODDe% AND %exp:cA2CODAte%
          AND SE2.E2_DTBORDE BETWEEN %exp:cE2DATABORDe% AND %exp:cE2DATABORAte%
          AND SE2.E2_EMISSAO BETWEEN %exp:cE2EMISSAODe% AND %exp:cE2EMISSAOAte%
          AND SE2.E2_VENCREA BETWEEN %exp:cE2VENCTODe% AND %exp:cE2VENCTOAte%
          AND SE2.E2_BAIXA  BETWEEN %exp:cE2BaixaDe% AND %exp:cE2BaixaAte%
     ORDER BY SE2.E2_FILIAL
             ,SE2.E2_DTBORDE
             ,SA2.A2_FILIAL
             ,SA2.A2_COD
             ,SE2.E2_PREFIXO
             ,SE2.E2_NUM
             ,SE2.E2_PARCELA

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCPagarRelatorioLiquidacao","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A2_COD","X3_TITULO","CÓDIGO")
    uToXML():setXMLVar("A2_NOME","X3_TITULO","FORNECEDOR")
    uToXML():setXMLVar("E2_DTBORDE","X3_TITULO","REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","TÍTULO")
    uToXML():setXMLVar("E2_EMISSAO","X3_TITULO","EMISSÃO")
    uToXML():setXMLVar("E2_VENCREA","X3_TITULO","VENCIMENTO")
    uToXML():setXMLVar("E2_VALLIQ","X3_TITULO","VALOR LIQUIDADO")
    uToXML():setXMLVar("E2_BAIXA","X3_TITULO","DATA LIQUIDAÇÃO")
    uToXML():setXMLVar("ZK4_NOSNUM","X3_TITULO","NOSSO NÚMERO")
    uToXML():setXMLVar("E2_FORNECE","X3_TITULO","CÓDIGO FORNECEDOR")
    uToXML():setXMLVar("E2_NOMFOR","X3_TITULO","NOME FORNECEDOR")
    uToXML():setXMLVar("TITFORORIG","X3_TITULO","TÍTULO ORIGINAL FORNECEDOR")

    uToXML():setXMLVar("A2_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A2_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_DTBORDE","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("P_NUM_PARC","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_BAIXA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VALLIQ","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("TITFORORIG","X3_PICTURE","@!")

    uToXML():setXMLVar("E2_VALLIQ","TOTAL",.T.)

    return(cTmpAlias)

static method getPagQueryCon(aParamRet,aFWTTables) class FIDC

    local aFields       as array

    local cSQLPath      as character
    local cSQLFile      as character
    local cSQLQuery     as character
    local cSQLInsert    as character

    local cTmpAlias     as character
    local cTmpTable     as character

    local cA2CODDe      as character
    local cA2CODAte     as character

    local cE2DATABORDe  as character
    local cE2DATABORAte as character

    local cE2EMISSAODe  as character
    local cE2EMISSAOAte as character

    local cE2VENCTODe   as character
    local cE2VENCTOAte  as character

    local cE2BaixaDe    as character
    local cE2BaixaAte   as character

    local cField        as character

    local cTableRem     as character
    local cTableRet     as character
    local cTableTit     as character
    local cTableLiq     as character

    local nField        as numeric
    local nFields       as numeric

    local oFWTTable     as object

    paramtype aParamRet  as array
    paramtype aFWTTables as array optional DEFAULT array(0)

    cA2CODDe:=aParamRet[1]
    cA2CODAte:=aParamRet[2]

    cE2DATABORDe:=DToS(aParamRet[3])
    cE2DATABORAte:=DToS(aParamRet[4])

    cE2EMISSAODe:=DToS(aParamRet[5])
    cE2EMISSAOAte:=DToS(aParamRet[6])

    cE2VENCTODe:=DToS(aParamRet[7])
    cE2VENCTOAte:=DToS(aParamRet[8])

    cE2BaixaDe:=DToS(aParamRet[9])
    cE2BaixaAte:=DToS(aParamRet[10])

    cTmpAlias:=FIDC():getPagQueryRem(@aParamRet,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableRem:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableRem:="%"+cTableRem+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=FIDC():getPagQueryRet(@aParamRet,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableRet:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableRet:="%"+cTableRet+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=FIDC():getPagQueryTit(@aParamRet,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableTit:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableTit:="%"+cTableTit+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=FIDC():getPagQueryLiq(@aParamRet,@aFWTTables)
    if (select(cTmpAlias)>0)
        cTableLiq:=aFWTTables[len(aFWTTables)]:getRealName()
        cTableLiq:="%"+cTableLiq+"%"
        (cTmpAlias)->(dbCloseArea())
    endif

    cTmpAlias:=getNextAlias()
    beginSQL alias cTmpAlias

        %noparser%

        COLUMN E2_DTBORDE  AS DATE
        COLUMN E2_EMISSAO  AS DATE
        COLUMN E2_VENCORI  AS DATE
        COLUMN E2_VENCREA  AS DATE
        COLUMN E2_BAIXA    AS DATE

        SELECT REM.A2_COD
              ,REM.A2_NOME
              ,REM.E2_DTBORDE
              ,REM.P_NUM_PARC
              ,REM.E2_EMISSAO
              ,REM.E2_VENCORI
              ,REM.DIAS_ANTEC
              ,REM.E2_VENCREA
              ,ISNULL(REM.E2_VALOR,0)   AS ENVIADO
              ,ISNULL(REM.E2_YANTDES,0) AS DESAGIO
              ,ISNULL(RET.E2_VALOR,0)   AS REGISTRADO
              ,ISNULL(LIQ.E2_VALLIQ,0)  AS BAIXADO
              ,(CASE WHEN ISNULL(REM.E2_VALOR,0)=ISNULL(RET.E2_VALOR,0)     THEN 'CONCILIADO' ELSE 'PENDENTE' END) AS REGISTRO
              ,(CASE WHEN ISNULL(LIQ.E2_VALLIQ,0)>=ISNULL(REM.E2_VALLIQ,0)  THEN 'CONCILIADO' ELSE 'PENDENTE' END) AS BAIXA
              ,(CASE WHEN ISNULL(LIQ.E2_VALLIQ,0)<ISNULL(REM.E2_VALLIQ,0)   THEN 'PENDENTE'   ELSE (CASE WHEN ((ISNULL(LIQ.E2_BAIXA,'')<>'') AND (ISNULL(LIQ.E2_BAIXA,'')<ISNULL(LIQ.E2_VENCREA,''))) THEN 'ANTECIPADO' ELSE (CASE WHEN ISNULL(LIQ.E2_BAIXA,'')=ISNULL(LIQ.E2_VENCREA,'') THEN 'CONCILIADO' ELSE 'VENCIDO' END) END) END) AS DTBAIXA
        FROM %exp:cTableRem% REM (NOLOCK)
        FULL OUTER JOIN %exp:cTableRet% RET (NOLOCK)
            ON (
                    REM.SE2RECNO=RET.SE2RECNO
         )
        FULL OUTER JOIN %exp:cTableTit% TIT (NOLOCK) ON (
                REM.SE2RECNO=TIT.SE2RECNO
         )
        FULL OUTER JOIN %exp:cTableLiq% LIQ (NOLOCK) ON (
                REM.SE2RECNO=LIQ.SE2RECNO
         )
        WHERE (1=2)
        ORDER BY REM.E2_DTBORDE
                ,REM.A2_COD
                ,REM.P_NUM_PARC

    endSQL

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLQuery:=getLastQuery()[2]
    cSQLQuery:=strTran(cSQLQuery,"(1=2)","(1=1)")

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCRelatorioRecebidos","00","qry_final",@cSQLPath,@cSQLFile)

    aFields:=(cTmpAlias)->(dbStruct())
    nFields:=len(aFields)

    (cTmpAlias)->(dbCloseArea())

    oFWTTable:=FWTemporaryTable():New(cTmpAlias,aFields)
    oFWTTable:Create()

    aAdd(aFWTTables,oFWTTable)

    cTmpTable:=oFWTTable:getRealName()

    cSQLInsert:="INSERT INTO"
    cSQLInsert+=" "
    cSQLInsert+=cTmpTable
    cSQLInsert+=" "
    cSQLInsert+="("
    for nField:=1 to nFields
        cField:=aFields[nField][DBS_NAME]
        cSQLInsert+=cField
        cSQLInsert+=","
    next nField
    cSQLInsert:=subStr(cSQLInsert,1,(Len(cSQLInsert)-1))
    cSQLInsert+=")"
    cSQLInsert+=" "
    cSQLInsert+=cSQLQuery

    begin transaction
        if (TCSQLExec(cSQLInsert)<0)
            DisarmTransaction()
            UserException(TCSQlError())
        endif
    end transaction

    (cTmpAlias)->(dbGoTop())

    utoXML():setSX3Fields((cTmpAlias)->(dbStruct()))

    uToXML():setXMLVar("A2_COD","X3_TITULO","CÓDIGO")
    uToXML():setXMLVar("A2_NOME","X3_TITULO","FORNECEDOR")
    uToXML():setXMLVar("E2_DTBORDE","X3_TITULO","REMESSA")
    uToXML():setXMLVar("P_NUM_PARC","X3_TITULO","Nº TÍTULO")
    uToXML():setXMLVar("E2_EMISSAO","X3_TITULO","EMISSAO")
    uToXML():setXMLVar("E2_VENCORI","X3_TITULO","VENCIMENTO REAL")
    uToXML():setXMLVar("DIAS_ANTEC","X3_TITULO","DIAS ANTECIPADOS")
    uToXML():setXMLVar("E2_VENCREA","X3_TITULO","NOVO VENCIMENTO")
    uToXML():setXMLVar("ENVIADO","X3_TITULO","ENVIADO")
    uToXML():setXMLVar("DESAGIO","X3_TITULO","DESAGIO")
    uToXML():setXMLVar("REGISTRADO","X3_TITULO","REGISTRADO")
    uToXML():setXMLVar("BAIXADO","X3_TITULO","BAIXADO")
    uToXML():setXMLVar("DTBAIXA","X3_TITULO","DT. BAIXA")

    uToXML():setXMLVar("A2_COD","X3_PICTURE","@!")
    uToXML():setXMLVar("A2_NOME","X3_PICTURE","@!")
    uToXML():setXMLVar("E2_DTBORDE","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_EMISSAO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("E2_VENCORI","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DIAS_ANTEC","X3_PICTURE","@R 9999")    
    uToXML():setXMLVar("E2_VENCREA","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("ENVIADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DESAGIO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("REGISTRADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("BAIXADO","X3_PICTURE","__NOTRANSFORM__")
    uToXML():setXMLVar("DTBAIXA","X3_PICTURE","__NOTRANSFORM__")

    uToXML():setXMLVar("DESAGIO","TOTAL",.T.)
    uToXML():setXMLVar("ENVIADO","TOTAL",.T.)
    uToXML():setXMLVar("REGISTRADO","TOTAL",.T.)
    uToXML():setXMLVar("BAIXADO","TOTAL",.T.)

    return(cTmpAlias)

static method getQueryMovBco(dDataRef) class FIDC

    local cSQLPath          as character
    local cSQLFile          as character
    local cSQLQuery         as character

    local cDataRef          as character

    local cTmpAlias         as character

    local cUnidadeCodigo    as character

    paramtype dDataRef as date optional default Date()

    cDataRef:=DToS(dDataRef)

    cUnidadeCodigo:=&("cEmpAnt")
    cUnidadeCodigo+=&("cFilAnt")

    cTmpAlias:=getNextAlias()

    beginSQL alias cTmpAlias

        %noparser%

        SELECT SUM(SE1.E1_VALOR-SE1.E1_YFDCVAL) AS NVLR
              ,COUNT(1) AS NQTDE
        FROM %table:SE1% SE1
        JOIN (
            SELECT SE1RECNO=Boleto.NumeroControleParticipante
                  ,CodigoBanco
                  ,Agencia
                  ,Conta
                  ,Lote.NomeArquivo
              FROM APIFINANCEIRO.dbo.Boleto  (NOLOCK)
              JOIN APIFINANCEIRO.dbo.Unidade (NOLOCK) ON (Unidade.ID=Boleto.UnidadeID)
              JOIN APIFINANCEIRO.dbo.Lote    (NOLOCK) ON (Lote.ID = Boleto.LoteID)
              JOIN APIFINANCEIRO.dbo.Cedente (NOLOCK) ON (Cedente.ID=Boleto.CedenteID)
              JOIN APIFINANCEIRO.dbo.ContaBancaria (NOLOCK) ON (ContaBancaria.ID=Cedente.ContaBancariaID)
             WHERE Lote.NomeArquivo<>''
               AND Unidade.Codigo=%exp:cUnidadeCodigo%
               AND CONVERT(DATE,APIFINANCEIRO.dbo.Boleto.InsertDate) BETWEEN CONVERT(DATE,%exp:cDataRef%) AND CONVERT(DATE,%exp:cDataRef%)
        ) QAPI ON (
                        SE1.R_E_C_N_O_=QAPI.SE1RECNO
                    AND SE1.E1_PORTADO=QAPI.CodigoBanco
                    AND SE1.E1_AGEDEP=QAPI.Agencia
                    AND SE1.E1_CONTA=QAPI.Conta
                    AND QAPI.NomeArquivo<>''
        )
        JOIN %table:SA6% SA6 ON (
                                SA6.A6_COD=SE1.E1_PORTADO
                            AND SA6.A6_AGENCIA=SE1.E1_AGEDEP
                            AND SA6.A6_NUMCON=SE1.E1_CONTA
                            AND SA6.%notDel%
                            AND SA6.A6_YTPINTB='1'
        )
        WHERE (1=1)
            AND SE1.E1_FILIAL=%xFilial:SE1%
            AND SE1.E1_NUMBOR<>' '
            AND SE1.E1_DATABOR=%exp:cDataRef%
            AND SE1.%notDel%
            AND SE1.E1_YSITAPI='2'
            AND SA6.A6_FILIAL=' '
            AND SA6.%notDel%
            AND SA6.A6_YTPINTB='1'
       GROUP BY SE1.E1_FILIAL
               ,SE1.E1_PORTADO
               ,SE1.E1_AGEDEP
               ,SE1.E1_CONTA

    endSQL

    cSQLQuery:=getLastQuery()[2]

    if (IsBlind())
        cSQLPath:="\tmp\"
    else
        cSQLPath:=getTempPath()
        if (!right(cSQLPath,1)=="\")
            cSQLPath+="\"
        endif
    endif
    cSQLPath+="FIDC\SQL\"

    cSQLFile:=""
    A35():writeSQLFile(@cSQLQuery,&("cEmpAnt"),&("cFilAnt"),"FIDCMovBcoFIDC","00","qry_final",@cSQLPath,@cSQLFile)

    return(cTmpAlias)

static method getRecParamRem(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCRelRemessa")
        lParamBox:=ParamBox(@aParamBox,@cParamTit,@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getRecParamRet(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCRelRetorno")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getRecParamRec(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Recebidos De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Recebidos Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif
        
        cFunName:=FunName()
        setFunName("FIDCRelRecebidos")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getRecParamCon(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Cliente Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A1_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA1"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A1_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_DATABOR","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E1_VENCTO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Consolidado De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Consolidado Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCPagarRelConsolidado")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

 static method getPagParamRem(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Taxa SELIC")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=0//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@R 999.99"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=10//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCPagarRelRemessa")
        lParamBox:=ParamBox(@aParamBox,@cParamTit,@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getPagParamRet(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif
        
        cFunName:=FunName()
        setFunName("FIDCRelRetorno")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

 static method getPagParamTit(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Retorno Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("ZK4_DATA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif
        
        cFunName:=FunName()
        setFunName("FIDCPagarRelTituloFornecedor")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getPagParamLiq(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Liquidação De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Liquidação Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCPagarRelLiquidacao")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method getPagParamCon(aParamRet) class FIDC

    local aArea     as array
    local aParamBox as array

    local cFunName  as character
    local cParamTit as character

    local lParamBox as logical

    local nPBoxAT   as numeric

    paramtype aParamRet as array optional default array(0)

    aArea:=FWGetArea()

    saveInter()

        aParamBox:=array(0)

        //01----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //02----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Fornecedor Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=Space(GetSx3Cache("A2_COD","X3_TAMANHO"))//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:=""//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:="SA2"//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("A2_COD","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //03----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //04----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Bordero Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_DTBORDE","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //05----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //06----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Emissao Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_EMISSAO","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //07----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //08----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Vencimento Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_VENCREA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //09----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Baixa De")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=CtoD("")//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.F.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        //10----------------------------------------------------------------------------------------------
        aAdd(aParamBox,array(9))
        nPBoxAT:=Len(aParamBox)
        aParamBox[nPBoxAT][1]:=1//[1]:1 - MsGet
        aParamBox[nPBoxAT][2]:=OemToAnsi("Data Baixa Ate")//[2]:Descricao
        aParamBox[nPBoxAT][3]:=date()//[3]:String contendo o inicializador do campo
        aParamBox[nPBoxAT][4]:="@D"//[4]:String contendo a Picture do campo
        aParamBox[nPBoxAT][5]:="AllWaysTrue()" //[5]:String contendo a validacao
        aParamBox[nPBoxAT][6]:=""//[6]:Consulta F3
        aParamBox[nPBoxAT][7]:="AllWaysTrue()"//[7]:String contendo a validacao When
        aParamBox[nPBoxAT][8]:=GetSx3Cache("E2_BAIXA","X3_TAMANHO")//[8]:Tamanho do MsGet
        aParamBox[nPBoxAT][9]:=.T.//[9]:Flag .T./.F. Parametro Obrigatorio ?

        if (type("cCadastro")=="C")
            cParamTit:=&("cCadastro")
        else
            cParamTit:=ProcName()
        endif

        cFunName:=FunName()
        setFunName("FIDCPagarRelConsolidado")
        lParamBox:=ParamBox(@aParamBox,&("cCadastro"),@aParamRet,/*bOk*/,/*aButtons*/,.T./*lCentered*/,/*nPosx*/,/*nPosy*/,/*oDlgWizard*/,/*cLoad*/,.T./*lCanSave*/,.T./*lUserSave*/)
        setFunName(cFunName)

    restInter()

    FWRestArea(aArea)

    return(lParamBox)

static method movBcoFIDC(dDataRef) class FIDC

    local aArea         as array
    local aErros        as array
    local aFields       as array

    local cTo           as character
    local cMsg          as character

    local cTmpAlias     as character

    local cASQLite      as character
    local cTSQLite      as character

    local cHTED         as numeric
    local cHCobranca    as numeric

    local cNTED         as numeric
    local cNCobranca    as numeric

    local cZKBFilial    as character
    local cZKBKeySeek   as character

    local cBody         as character
    local cSubject      as character

    local cExcelFile    as character
    local cExcelTitle   as character

    local lRet          as logical
    local lHasError     as logical
    local lNewMovBco    as logical

    local lPicture      as logical
    local lX3Titulo     as logical
    local ltxtEditMemo  as logical

    local nTTED         as numeric
    local nTCobranca    as numeric

    local nErro         as numeric
    local nErros        as numeric

    local nZKBOrder     as numeric
    local nZKBCount     as numeric

    local oMovBco       as object

    paramtype dDataRef as date optional default Date()

    aArea:=FWGetArea()

    begin sequence

        cTmpAlias:=FIDC():getQueryMovBco(@dDataRef)

        lRet:=(cTmpAlias)->(!eof())

        if (!lRet)
            break
        endif

        cBanco:=PadR("001",getSX3Cache("A6_COD","X3_TAMANHO"))
        cAgencia:=PadR("34312",getSX3Cache("A6_AGENCIA","X3_TAMANHO"))
        cConta:=PadR("55.097-3",getSX3Cache("A6_NUMCON","X3_TAMANHO"))

        nZKBCount:=0
        nZKBOrder:=retOrder("ZKB","ZKB_FILIAL+ZKB_BANCO+ZKB_CODHIS")
        ZKB->(dbSetOrder(nZKBOrder))
        cZKBFilial:=xFilial("ZKB")
        cZKBKeySeek:=cZKBFilial
        cZKBKeySeek+="001FIDC"
        if (ZKB->(dbSeek(cZKBKeySeek,.F.)))
            while (ZKB->(!eof().and.(ZKB_FILIAL+ZKB_BANCO+ZKB_CODHIS)==cZKBKeySeek))
                if ("2923"$ZKB->ZKB_NATFIN)
                    cHTED:=ZKB->ZKB_DESC
                    cNTED:=ZKB->ZKB_NATFIN
                    nTTED:=ZKB->ZKB_VALOR
                    nZKBCount++
                elseif ("2915"$ZKB->ZKB_NATFIN)
                    cHCobranca:=ZKB->ZKB_DESC
                    cNCobranca:=ZKB->ZKB_NATFIN
                    nTCobranca:=ZKB->ZKB_VALOR
                    nZKBCount++
                endif
                if (nZKBCount>=2)
                    exit
                endif
                ZKB->(dbskip())
            end while
        endif

        aFields:=array(0)

        aAdd(aFields,{"E5_RECPAG",getSX3Cache("E5_RECPAG","X3_TIPO"),getSX3Cache("E5_RECPAG","X3_TAMANHO"),getSX3Cache("E5_RECPAG","X3_DECIMAL")})
        aAdd(aFields,{"E5_DATA",getSX3Cache("E5_DATA","X3_TIPO"),getSX3Cache("E5_DATA","X3_TAMANHO"),getSX3Cache("E5_DATA","X3_DECIMAL")})
        aAdd(aFields,{"E5_DTDIGIT",getSX3Cache("E5_DTDIGIT","X3_TIPO"),getSX3Cache("E5_DTDIGIT","X3_TAMANHO"),getSX3Cache("E5_DTDIGIT","X3_DECIMAL")})
        aAdd(aFields,{"E5_DTDISPO",getSX3Cache("E5_DTDISPO","X3_TIPO"),getSX3Cache("E5_DTDISPO","X3_TAMANHO"),getSX3Cache("E5_DTDISPO","X3_DECIMAL")})
        aAdd(aFields,{"E5_MOEDA",getSX3Cache("E5_MOEDA","X3_TIPO"),getSX3Cache("E5_MOEDA","X3_TAMANHO"),getSX3Cache("E5_MOEDA","X3_DECIMAL")})
        aAdd(aFields,{"E5_VALOR",getSX3Cache("E5_VALOR","X3_TIPO"),getSX3Cache("E5_VALOR","X3_TAMANHO"),getSX3Cache("E5_VALOR","X3_DECIMAL")})
        aAdd(aFields,{"E5_NATUREZ",getSX3Cache("E5_NATUREZ","X3_TIPO"),getSX3Cache("E5_NATUREZ","X3_TAMANHO"),getSX3Cache("E5_NATUREZ","X3_DECIMAL")})
        aAdd(aFields,{"E5_BANCO",getSX3Cache("E5_BANCO","X3_TIPO"),getSX3Cache("E5_BANCO","X3_TAMANHO"),getSX3Cache("E5_BANCO","X3_DECIMAL")})
        aAdd(aFields,{"E5_AGENCIA",getSX3Cache("E5_AGENCIA","X3_TIPO"),getSX3Cache("E5_AGENCIA","X3_TAMANHO"),getSX3Cache("E5_AGENCIA","X3_DECIMAL")})
        aAdd(aFields,{"E5_CONTA",getSX3Cache("E5_CONTA","X3_TIPO"),getSX3Cache("E5_CONTA","X3_TAMANHO"),getSX3Cache("E5_CONTA","X3_DECIMAL")})
        aAdd(aFields,{"E5_HISTOR",getSX3Cache("E5_HISTOR","X3_TIPO"),getSX3Cache("E5_HISTOR","X3_TAMANHO"),getSX3Cache("E5_HISTOR","X3_DECIMAL")})
        aAdd(aFields,{"E5_CC",getSX3Cache("E5_CCD","X3_TIPO"),getSX3Cache("E5_CCD","X3_TAMANHO"),getSX3Cache("E5_CCD","X3_DECIMAL")})
        aAdd(aFields,{"E5_CLVL",getSX3Cache("E5_CLVLDB","X3_TIPO"),getSX3Cache("E5_CLVLDB","X3_TAMANHO"),getSX3Cache("E5_CLVLDB","X3_DECIMAL")})

        aAdd(aFields,{"STATUS","C",10,0})
        aAdd(aFields,{"MSG","M",80,0})

        cTSQLite:=criaTrab(nil,.F.)
        dbCreate(cTSQLite,aFields,"SQLITE_MEM")
        cASQLite:=getNextAlias()
        dbUseArea(.T.,"SQLITE_MEM",cTSQLite,cASQLite,.F.,.F.)

        while (cTmpAlias)->(!eof())

            if (cASQLite)->(recLock(cASQLite,.T.))
                (cASQLite)->E5_RECPAG:="R"
                (cASQLite)->E5_DATA:=dDataRef
                (cASQLite)->E5_DTDIGIT:=dDataRef
                (cASQLite)->E5_DTDISPO:=dDataRef
                (cASQLite)->E5_MOEDA:="M1"
                (cASQLite)->E5_VALOR:=(cTmpAlias)->NVLR
                (cASQLite)->E5_NATUREZ:="1220"
                (cASQLite)->E5_BANCO:=cBanco
                (cASQLite)->E5_AGENCIA:=cAgencia
                (cASQLite)->E5_CONTA:=cConta
                (cASQLite)->E5_HISTOR:="REPASSE GOLDEN"
                (cASQLite)->E5_CC:="1000"
                (cASQLite)->E5_CLVL:="1101"
                (cASQLite)->(msUnLock())
            endif

            if (cASQLite)->(recLock(cASQLite,.T.))
                (cASQLite)->E5_RECPAG:="P"
                (cASQLite)->E5_DATA:=dDataRef
                (cASQLite)->E5_DTDIGIT:=dDataRef
                (cASQLite)->E5_DTDISPO:=dDataRef
                (cASQLite)->E5_MOEDA:="M1"
                (cASQLite)->E5_VALOR:=nTTED
                (cASQLite)->E5_NATUREZ:=cNTED
                (cASQLite)->E5_BANCO:=cBanco
                (cASQLite)->E5_AGENCIA:=cAgencia
                (cASQLite)->E5_CONTA:=cConta
                (cASQLite)->E5_HISTOR:=cHTED
                (cASQLite)->E5_CC:="1000"
                (cASQLite)->E5_CLVL:="1215"
                (cASQLite)->(msUnLock())
            endif

            if (cASQLite)->(recLock(cASQLite,.T.))
                (cASQLite)->E5_RECPAG:="P"
                (cASQLite)->E5_DATA:=dDataRef
                (cASQLite)->E5_DTDIGIT:=dDataRef
                (cASQLite)->E5_DTDISPO:=dDataRef
                (cASQLite)->E5_MOEDA:="M1"
                (cASQLite)->E5_VALOR:=(nTCobranca*(cTmpAlias)->NQTDE)
                (cASQLite)->E5_NATUREZ:=cNCobranca
                (cASQLite)->E5_BANCO:=cBanco
                (cASQLite)->E5_AGENCIA:=cAgencia
                (cASQLite)->E5_CONTA:=cConta
                (cASQLite)->E5_HISTOR:=cHCobranca
                (cASQLite)->E5_CC:="1000"
                (cASQLite)->E5_CLVL:="1215"
                (cASQLite)->(msUnLock())
            endif

            (cTmpAlias)->(dbSkip())

        end while

        (cTmpAlias)->(dbCloseArea())

        oMovBco:=TAFMovimentoBancario():New()

        (cASQLite)->(dbGoTop())

        begin transaction

            while (cASQLite)->(!eof())
                oMovBco:cRecPag:=(cASQLite)->E5_RECPAG
                oMovBco:dData:=(cASQLite)->E5_DATA
                oMovBco:dDigit:=(cASQLite)->E5_DTDIGIT
                oMovBco:dDispo:=(cASQLite)->E5_DTDISPO
                oMovBco:cMoeda:=(cASQLite)->E5_MOEDA
                oMovBco:nValor:=(cASQLite)->E5_VALOR
                oMovBco:cNatureza:=(cASQLite)->E5_NATUREZ
                oMovBco:cBanco:=(cASQLite)->E5_BANCO
                oMovBco:cAgencia:=(cASQLite)->E5_AGENCIA
                oMovBco:cConta:=(cASQLite)->E5_CONTA
                oMovBco:cHistorico:=(cASQLite)->E5_HISTOR
                oMovBco:cCentroCusto:=(cASQLite)->E5_CC
                oMovBco:cClasseValor:=(cASQLite)->E5_CLVL
                oMovBco:nIdApi:=0
                lNewMovBco:=(!oMovBco:Exists())
                if (lNewMovBco)
                    lRet:=oMovBco:Insert()
                    if (cASQLite)->(recLock(cASQLite,.F.))
                        (cASQLite)->STATUS:=if(lRet,"1-OK","0-ERROR")
                        if (!lRet)
                            lHasError:=.T.
                            aErros:=GetAutoGRLog()
                            nErros:=Len(aErros)
                            cMsg:=""
                            if (nErros>0)
                                for nErro:= 1 to nErros
                                    cMsg+=aErros[nErro]
                                next nErros
                            else
                                cMsg+="Ocorreram erros na inclusao do Movimento Bancario"
                            endif
                            (cASQLite)->MSG:=cMsg
                        else
                            cMsg:="Movimento Bancario Incluido com Sucesso"
                            (cASQLite)->MSG:=cMsg
                        endif
                        (cASQLite)->(MsUnLock())
                    endif
                else
                    if (cASQLite)->(recLock(cASQLite,.F.))
                        (cASQLite)->STATUS:="2-Exists"
                        cMsg:="Ja Existe Este Movimento Bancario"
                        (cASQLite)->MSG:=cMsg
                        (cASQLite)->(MsUnLock())
                    endif
                endif
                (cASQLite)->(dbSkip())
            end while

        end transaction

        cExcelTitle:="MOVBCOFIDC"
        cExcelTitle+=" :: "
        cExcelTitle+="Empresa: "+&("cEmpAnt")
        cExcelTitle+=" :: "
        cExcelTitle+="Filial: "+&("cFilAnt")
        cExcelTitle+=" :: "
        cExcelTitle+="Data: "+DToC(dDataRef)
        cExcelTitle+=" :: "
        cExcelTitle+="Hora: "+Time()

        cExcelFile:="\fidc\"
        cExcelFile+="movbcofidc\"
        cExcelFile+="MOVBCOFIDC"
        cExcelFile+="_"
        cExcelFile+=DtoS(dDataRef)
        cExcelFile+="_"
        cExcelFile+=StrTran(Time(),":","_")
        cExcelFile+="_"
        cExcelFile+=cValtoChar(Seconds())
        cExcelFile+=".xml"

        dirtools():MakeFileDir(cExcelFile)

        lPicture:=.T.
        lX3Titulo:=.T.
        ltxtEditMemo:=.F.

        (cASQLite)->(dbGoTop())

        uToXML():setXMLVar("E5_DATA","X3_PICTURE","__NOTRANSFORM__")
        uToXML():setXMLVar("E5_DTDIGIT","X3_PICTURE","__NOTRANSFORM__")
        uToXML():setXMLVar("E5_DTDISPO","X3_PICTURE","__NOTRANSFORM__")
        uToXML():setXMLVar("E5_MOEDA","X3_PICTURE","__NOTRANSFORM__")
        uToXML():setXMLVar("E5_VALOR","X3_PICTURE","__NOTRANSFORM__")

        uToXML():setXMLVar("STATUS","X3_PICTURE","__NOTRANSFORM__")

        uToXML():setXMLVar("GENERAL","lIsBlind",.T.)
        lRet:=uToXML():QryToXML(@cASQLite,@cExcelFile,@cExcelTitle,@lPicture,@lX3Titulo,@ltxtEditMemo)

        uToXML():clearXMLVar()

        (cASQLite)->(dbCloseArea())

        lRet:=file(cExcelFile)

        //TODO: Incluir na rotina de Workflow de e-mail BIA191 para recuperação via u_emailWF
        //ex.: u_emailWF("MOVBCOFIDCXML",&("cEmpAnt"))
        cTo:=u_emailWF("MOVBCOFIDCXML",&("cEmpAnt"))

        if (empty(cTo))
            break
        endif

        if (!lRet)
            break
        endif

        cSubject:="MOVBCOFIDC :: "
        cSubject+="Movimentacao Bancaria FIDC "
        cSubject+=" :: Emissao: "
        cSubject+=DtoC(msDate())
        cSubject+=" :: "+Time()

        cBody:="Segue, anexo, dados das movimentacoes bancarias processadas"
        cBody+=" "
        cBody+=cSubject

        cFWLogMsg:="MOVBCOFIDC Enviando e-mail para: "
        cFWLogMsg+=cTo
        FWLogMsg("MSG",nil,"MOVBCOFIDC","INFO","1","1",cFWLogMsg,1,0,{})
        cFWLogMsg:=cSubject
        FWLogMsg("MSG",nil,"MOVBCOFIDC","INFO","1","2",cFWLogMsg,1,0,{})
        lRet:=u_BIAEnvMail(nil,cTo,cSubject,cBody,nil,cExcelFile)
        if (lRet)
            if (file(cExcelFile))
                fErase(cExcelFile)
            endif
            cFWLogMsg:="MOVBCOFIDC e-mail enviado com sucesso para: "
            cFWLogMsg+=cTo
            FWLogMsg("MSG",nil,"MOVBCOFIDC","INFO","1","3",cFWLogMsg,1,0,{})
        else
            cFWLogMsg:="MOVBCOFIDC problemas no envio de e-mail para: "
            cFWLogMsg+=cTo
            FWLogMsg("WARNIG",nil,"MOVBCOFIDC","ERROR","1","4",cFWLogMsg,1,0,{})
        endif

    end sequence

    DEFAULT lHasError:=.F.

    if (!empty(cASQLite))
        if (select(cASQLite)>0)
            (cASQLite)->(dbCloseArea())
        endif
    endif

    if (!empty(cTmpAlias))
        if (select(cTmpAlias)>0)
            (cTmpAlias)->(dbCloseArea())
        endif
    endif

    FWRestArea(aArea)

    if (lRet)
        lRet:=(!lHasError)
    endif

    return(lRet)

static method getVlrCTBPagar() class FIDC

    local nValorCTB as numeric

    begin sequence

        nValorCTB:=0

        if (!FIDC():isctbFIDC(2))
            break
        endif

        nValorCTB:=SE2->E2_VALOR

    end sequence

    return(nValorCTB)

static method getHisCTBPagar(cTypeHist) class FIDC
    
    local aArea         as array
    local aAreaSA2      as array
    local aAreaSE2      as array
    
    local cHistCTB      as character

    local nSA2RecNo     as numeric

    local oJSONFIDC     as object
    local oJSONOrigem   as object

    paramtype cTypeHist as character

    aArea:=FWGetArea()
    aAreaSA2:=SA2->(getArea())
    aAreaSE2:=SE2->(getArea())
 
    begin sequence

        cHistCTB:=""

        if (!FIDC():isctbFIDC(2))
            break
        endif

        oJSONFIDC:=cacheData():Get("FIDC0001","FIDC",JSONArray():New())
        oJSONOrigem:=cacheData():Get("FIDC0001","ORIGEM",JSONArray():New())

        if (cTypeHist=="ORIGEM")
            nSA2RecNo:=cacheData():Get("FIDC0001","nSA2RecNoOrigem",0)
            SA2->(MsGoTo(nSA2RecNo))
            cHistCTB+="VLR ANTEC FIDC NF"
            cHistCTB+=" "
            cHistCTB+=oJSONOrigem:Get("CNUMERO","")
            cHistCTB+=" "
            cHistCTB+=SA2->A2_NOME
        elseif (cTypeHist=="FIDC")
            cHistCTB+="VLR TIT"
            cHistCTB+=" "
            cHistCTB+=oJSONFIDC:Get("CNUMERO","")
            cHistCTB+=" "
            cHistCTB+="GOLDEN REF"
            cHistCTB+=" "
            cHistCTB+=oJSONOrigem:Get("CNUMERO","")
        endif

        cHistCTB:=Left(cHistCTB,getSX3Cache("CT2_HIST","X3_TAMANHO"))

    end sequence

    restArea(aAreaSA2)
    restArea(aAreaSE2)
    FWRestArea(aArea)

    return(cHistCTB)

 static method getCTACTBPagar(cTypeCTA) class FIDC
    
    local aArea         as array
    local aAreaSA2      as array
    local aAreaSE2      as array
    
    local cCTACTB       as character

    local nSA2RecNo     as numeric

    local oJSONFIDC     as object
    local oJSONOrigem   as object

    paramtype cTypeCTA as character

    aArea:=FWGetArea()
    aAreaSA2:=SA2->(getArea())
    aAreaSE2:=SE2->(getArea())
 
    begin sequence

        cCTACTB:=""

        if (!FIDC():isctbFIDC(2))
            break
        endif

        oJSONFIDC:=cacheData():Get("FIDC0001","FIDC",JSONArray():New())
        oJSONOrigem:=cacheData():Get("FIDC0001","ORIGEM",JSONArray():New())

        if (cTypeCTA=="ORIGEM")
            nSA2RecNo:=cacheData():Get("FIDC0001","nSA2RecNoOrigem",0)
            SA2->(MsGoTo(nSA2RecNo))
            cCTACTB+="21102001"+SA2->A2_COD
        elseif (cTypeCTA=="FIDC")
            cCTACTB+="21102001015050"
        endif

    end sequence

    restArea(aAreaSA2)
    restArea(aAreaSE2)
    FWRestArea(aArea)

    return(cCTACTB)

static method isPGFIDC(lHelp,cMsg) class FIDC
    local aArea     as array
    local cTmpAlias as character
    local lisPGFIDC as logical
    paramtype lHelp as logical optional default .T.
    paramtype cMsg as character optional default "Títulos FIDC não podem ser modificados."
    aArea:=FWGetArea()
    lisPGFIDC:=(SE2->((FieldPos("E2_YANTTX")>0).and.(FieldPos("E2_YANTDES")>0)))
    if (lisPGFIDC)
        lisPGFIDC:=(SE2->((E2_YANTTX>0).and.(E2_YANTDES>0)))
        if (!lisPGFIDC)
            cTmpAlias:=getNextAlias()
            beginSQL alias cTmpAlias
                SELECT ISNULL(t.FIDC,0) FIDC 
                FROM (
                            SELECT DISTINCT 1 AS FIDC 
                            FROM %table:SE5% SE5 (NOLOCK)
                            JOIN %table:SE2% SE2 (NOLOCK) ON (
                                    SE5.E5_PREFIXO=SE2.E2_PREFIXO
                                AND SE5.E5_NUMERO=SE2.E2_NUM
                                AND SE5.E5_PARCELA=SE2.E2_PARCELA
                                AND SE5.E5_CLIFOR=SE2.E2_FORNECE
                                AND SE5.E5_LOJA=SE2.E2_LOJA
                            )
                            WHERE SE5.%notDel% 
                              AND SE2.%notDel%
                              AND SE5.E5_FILIAL=%exp:SE2->E2_FILIAL%
                              AND SE5.E5_PREFIXO=%exp:SE2->E2_PREFIXO%
                              AND SE5.E5_NUMERO=%exp:SE2->E2_NUM%
                              AND SE5.E5_PARCELA=%exp:SE2->E2_PARCELA%
                              AND SE5.E5_CLIFOR=%exp:SE2->E2_FORNECE%
                              AND SE5.E5_LOJA=%exp:SE2->E2_LOJA%
                              AND SE5.E5_RECPAG='P'
                              AND SE5.E5_MOTBX='FDC'
                              AND SE5.E5_DTCANBX='' 
                ) t
            endSQL
            lisPGFIDC:=((cTmpAlias)->FIDC==1)
            (cTmpAlias)->(dbCloseArea())
            dbSelectArea("SE2")
        endif
    endif
    if (lisPGFIDC)
        if ((lHelp).and.(!empty(cMsg)))
            Help(nil,nil,"__FIDC__","__FIDC__",cMsg,1,0,nil,nil,nil,nil,nil,{"Títulos FIDC não podem ser modificados."})
        endif
    endif
    FWRestArea(aArea)
    return(lisPGFIDC)

static method isRecFIDC(lHelp,cMsg) class FIDC
    local aArea     as array
    local lisRecFIDC as logical
    paramtype lHelp as logical optional default .F.
    paramtype cMsg as character optional default "Títulos FIDC não podem ser modificados."
    aArea:=FWGetArea()
    FIDC():setFIDCVar("cBanco",SE1->E1_PORTADO)
    FIDC():setFIDCVar("cAgencia",SE1->E1_AGEDEP)
    FIDC():setFIDCVar("cConta",SE1->E1_CONTA)
    lisRecFIDC:=FIDC():bcoIsFIDC()
    if (lisRecFIDC)
        if ((lHelp).and.(!empty(cMsg)))
            Help(nil,nil,"__FIDC__","__FIDC__",cMsg,1,0,nil,nil,nil,nil,nil,{"Títulos FIDC não podem ser modificados."})
        endif
    endif
    FWRestArea(aArea)
    return(lisRecFIDC)

static method getLPFIDC(nType) class FIDC
    
    local cLPFIDC   as character
    
    paramtype nType as numeric optional default 1

    if (nType==1)
        cLPFIDC:=FIDC():getBiaPar("FIDC_LP_BAIXA","FBX")
        cLPFIDC+=","
        cLPFIDC+=FIDC():getBiaPar("FIDC_LP_BORDERO","FBO")
        cLPFIDC+=","
        cLPFIDC+="520,521,527"
    elseif (nType==2)
        cLPFIDC:="510"
    else
        cLPFIDC:=""
    endif

    return(cLPFIDC)

    static method getPGFilterFIDC(lAdvPL) class FIDC
        local cExpFilter    as character
        paramtype lAdvPL as logical optional default .F.
        if (SE2->((FieldPos("E2_YANTTX")>0).and.(FieldPos("E2_YANTDES")>0)))
            if (lAdvPL)
                cExpFilter:="(E2_YANTTX==0).AND.(E2_YANTDES==0)"
            else
                cExpFilter:="("
                cExpFilter+="   (E2_YANTTX=0) AND (E2_YANTDES=0)"
                cExpFilter+="   OR "
                cExpFilter+="   ("
                cExpFilter+="   SELECT ISNULL(t.FIDC,0) FIDC" 
                cExpFilter+="       FROM ("
                cExpFilter+="                SELECT DISTINCT 1 AS FIDC"
                cExpFilter+="                  FROM "+RetSQLName("SE5")+" SE5 (NOLOCK)"
                cExpFilter+="                 WHERE SE5.D_E_L_E_T_=''" 
                cExpFilter+="                   AND SE5.E5_FILIAL=E2_FILIAL"
                cExpFilter+="                   AND SE5.E5_PREFIXO=E2_PREFIXO"
                cExpFilter+="                   AND SE5.E5_NUMERO=E2_NUM"
                cExpFilter+="                   AND SE5.E5_PARCELA=E2_PARCELA"
                cExpFilter+="                   AND SE5.E5_CLIFOR=E2_FORNECE"
                cExpFilter+="                   AND SE5.E5_LOJA=E2_LOJA"
                cExpFilter+="                   AND SE5.E5_MOTBX='FDC'"
                cExpFilter+="                   AND SE5.E5_DTCANBX=''"
                cExpFilter+="   ) t )=0"
                cExpFilter+=")"
            endif
            while ("  "$cExpFilter)
                cExpFilter:=strTran(cExpFilter,"  "," ")
            end while
        endif
        DEFAULT cExpFilter:=""
        return(cExpFilter)

 method FIDCYLEGEND(nType) class FIDC

    static s__cFIDCLegend as character 

    local cYLegend as character

    paramtype nType as numeric optional default 1

    if ((nType==1).and.(SE1->E1_YFDCVAL>0))
        DEFAULT s__cFIDCLegend:=u_F040ADLE()[1][1]
        cYLegend:=s__cFIDCLegend
    elseif ((nType==2).and.(SE2->((E2_YANTTX>0).and.(E2_YANTDES>0))))    
        DEFAULT s__cFIDCLegend:=u_F040ADLE()[1][1]
        cYLegend:=s__cFIDCLegend
    else
        cYLegend:=""
    endif

    return(cYLegend)
